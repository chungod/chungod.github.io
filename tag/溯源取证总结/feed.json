{
    "version": "https://jsonfeed.org/version/1",
    "title": "Go Forward • All posts by \"溯源取证总结\" tag",
    "description": "欢迎来到我的博客(*^﹏^*),本人为新人,你可以阅读我的学习笔记并提出独到的见解~我们将互相学习,共同进步,望大佬们勿喷",
    "home_page_url": "http://chungod.github.io",
    "items": [
        {
            "id": "http://chungod.github.io/2021/05/05/%E6%BA%AF%E6%BA%90%E5%8F%96%E8%AF%81%E6%80%BB%E7%BB%93/",
            "url": "http://chungod.github.io/2021/05/05/%E6%BA%AF%E6%BA%90%E5%8F%96%E8%AF%81%E6%80%BB%E7%BB%93/",
            "title": "溯源取证总结",
            "date_published": "2021-05-05T07:17:48.000Z",
            "content_html": "<h2 id=\"溯源取证总结\"><a class=\"markdownIt-Anchor\" href=\"#溯源取证总结\">#</a> 溯源取证总结</h2>\n<h4 id=\"类型\"><a class=\"markdownIt-Anchor\" href=\"#类型\">#</a> 类型</h4>\n<ul>\n<li>web 入侵：挂马、网页篡改（博彩 / 黑帽 SEO 等）、植入 webshell，黑页，暗链等</li>\n<li>主机入侵：病毒木马、勒索软件、远控后门、系统异常、RDP 爆破、SSH 爆破、主机漏洞、数据库入侵等</li>\n<li>网络攻击：DDOS 攻击、DNS/HTTP 劫持、ARP 欺骗等</li>\n<li>路由器 / 交换机异常：内网病毒，配置错误等</li>\n</ul>\n<h4 id=\"初步信息收集\"><a class=\"markdownIt-Anchor\" href=\"#初步信息收集\">#</a> 初步信息收集</h4>\n<ul>\n<li>客户属性：如名称 / 区域 / 领域等</li>\n<li>入侵范围：如主机数 / 网段等</li>\n<li>入侵现象：如 cpu 过高，勒索界面，异常网络链接，安全设备告警等</li>\n<li>客户需求：是否要求溯源，是否要求协助修复等</li>\n<li>收集信息：操作系统版本，补丁，数据库版本，中间件 / 服务器，网络拓扑，受害范围，处置情况，提取日志（主机，安全设备，数据库等）</li>\n</ul>\n<p>应急响应资源:<span class=\"exturl\" data-url=\"aHR0cHM6Ly9naXRodWIuY29tL3RoZUxTQS9oYWNrLWVyLXRvb2xz\">https://github.com/theLSA/hack-er-tools</span></p>\n<h4 id=\"分析流程image-20210505094445689\"><a class=\"markdownIt-Anchor\" href=\"#分析流程image-20210505094445689\">#</a> 分析流程<img data-src=\"https://gitee.com/chungod/picture/raw/master/image/image-20210505094445689.png\" alt=\"image-20210505094445689\"></h4>\n<h2 id=\"web应急响应\"><a class=\"markdownIt-Anchor\" href=\"#web应急响应\">#</a> Web 应急响应</h2>\n<p><code>各类中间件/服务器日志默认存放位置</code></p>\n<table>\n<thead>\n<tr>\n<th>服务名</th>\n<th>服务器日志默认存放位置</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>IIS</td>\n<td>C:\\WINDOWS\\system32\\LogFiles</td>\n</tr>\n<tr>\n<td>apache</td>\n<td>Linux：/usr/local/apache/logs/<br/>Windows：apache/logs/</td>\n</tr>\n<tr>\n<td>tomcat</td>\n<td>conf/logging.properties<br/>logs/catalina.xx.log<br/>logs/host-manager.xx.log<br/>logs/localhost.xx.log<br/>logs/manager.xx.log<br/>主要记录系统启、关闭日志、管理日志和异常信息</td>\n</tr>\n<tr>\n<td>weblogic</td>\n<td>domain_name/servers/server_name/logs/<br/>server_name.log：server 启停日志<br/>access.log：安装在该 server 之上的应用 http 访问日志</td>\n</tr>\n<tr>\n<td>jboss</td>\n<td>LOG4J 配置默认 Deploy/conf/<br/>如 jboss/server/default/conf/jboss-log4j.xml</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"webshell排查\"><a class=\"markdownIt-Anchor\" href=\"#webshell排查\">#</a> webshell 排查</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">1. 整站打包用webshell扫描工具扫</span><br><span class=\"line\">2. 利用Linux find命令查询木马</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight clojure\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">find /var/www/ -name &quot;*.php&quot; |xargs egrep &#x27;assert|phpspy|c99sh|milw0rm|eval|(gunerpress|</span><br><span class=\"line\">(<span class=\"name\">base64_decoolcode</span>|spider_bc|shell_exec|passthru|($_\\POST[|eval</span><br><span class=\"line\">(<span class=\"name\">str_rot13</span>|.chr(|$&#123;<span class=\"string\">&quot;_P|eval($_R|file_put_contents(.*$_|base64_decode</span></span><br></pre></td></tr></table></figure>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">grep -i –r eval($_post /app/website/*</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">find /app/website/ -type f|xargs grep eval($_post</span><br></pre></td></tr></table></figure>\n<h4 id=\"数据库排查\"><a class=\"markdownIt-Anchor\" href=\"#数据库排查\">#</a> 数据库排查</h4>\n<p><code>mysql和mssql日志</code></p>\n<table>\n<thead>\n<tr>\n<th>日志类型 (mysql)</th>\n<th></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>错误日志</td>\n<td>默认开启，hostname.error</td>\n</tr>\n<tr>\n<td>查询日志</td>\n<td>记录用户的所有操作。默认关闭，general_log_file（常见 getshell 手法）</td>\n</tr>\n<tr>\n<td>慢查询日志</td>\n<td>记录执行时间超过指定时间的查询语句，slow_query_log_file（慢查询 getshell）</td>\n</tr>\n<tr>\n<td>事务日志</td>\n<td>ib_logfile0</td>\n</tr>\n<tr>\n<td>二进制日志</td>\n<td>记录修改数据或有可能引起数据改变的 mysql 语句，log_bin，默认在数据目录，如<br/>mysql-bin.000001</td>\n</tr>\n<tr>\n<td>日志类型 (mssql) 版本 ****</td>\n<td><strong>默认路径</strong></td>\n</tr>\n<tr>\n<td>SQL SERVER 2005</td>\n<td>Program Files\\Microsoft SQL Server\\MSSQL.<em>n</em>\\MSSQL\\LOG</td>\n</tr>\n<tr>\n<td>SQL SERVER 2008</td>\n<td>Program Files\\Microsoft SQL Server\\MSSQL10. 实例名 \\MSSQL\\LOG</td>\n</tr>\n<tr>\n<td>SQL SERVER 2008 R2</td>\n<td>Program Files\\Microsoft SQL Server\\MSSQL10_50. 实例名 \\MSSQL\\LOG</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br><span class=\"line\">18</span><br><span class=\"line\">19</span><br><span class=\"line\">20</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">小总结</span><br><span class=\"line\">1. mysql\\lib\\plugin目录的异常文件</span><br><span class=\"line\"></span><br><span class=\"line\">2. select * from mysql.func的异常</span><br><span class=\"line\"></span><br><span class=\"line\">3. mssql检查xp_cmdshell等存储过程</span><br><span class=\"line\"></span><br><span class=\"line\">4. 异常数据库登录</span><br><span class=\"line\"></span><br><span class=\"line\">5. 数据库用户弱口令</span><br><span class=\"line\"></span><br><span class=\"line\">6. mysql相关命令</span><br><span class=\"line\">show global variables like &#39;%log%&#39;;</span><br><span class=\"line\">show global variables like &#39;%gene%&#39;;</span><br><span class=\"line\">show master status;</span><br><span class=\"line\">systemmore &#x2F;mydata&#x2F;data&#x2F;stu18_slow.log;</span><br><span class=\"line\">showbinary logs;</span><br><span class=\"line\">showmaster logs;</span><br><span class=\"line\">showbinlog events in &#39;mysql-bin.000011&#39;;</span><br><span class=\"line\">show processlist;</span><br></pre></td></tr></table></figure>\n<h2 id=\"linux应急响应\"><a class=\"markdownIt-Anchor\" href=\"#linux应急响应\">#</a> Linux 应急响应</h2>\n<h4 id=\"文件\"><a class=\"markdownIt-Anchor\" href=\"#文件\">#</a> 文件</h4>\n<table>\n<thead>\n<tr>\n<th>Linux 命令</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>ls -alt</td>\n<td>按时间排序以长字符串的形式显示所有文件</td>\n</tr>\n<tr>\n<td>find / -ctime 2</td>\n<td>查找 72 小时内新增的文件</td>\n</tr>\n<tr>\n<td>find ./ -mtime 0 -name “*.jsp”</td>\n<td>查找 24 小时内被修改的 JSP 文件</td>\n</tr>\n<tr>\n<td>ls -al /tmp |grep “Feb 27”</td>\n<td>根据确定时间去反推变更的文件</td>\n</tr>\n<tr>\n<td>find / *.jsp -perm 4777</td>\n<td>查找 777 的权限的文件</td>\n</tr>\n<tr>\n<td>strings /usr/bin/.sshd |egrep ‘<span 1,3=\"\">1-9</span>.<span 1,3=\"\">1-9</span>.’</td>\n<td>分析 sshd 文件是否包括 IP 信息</td>\n</tr>\n<tr>\n<td>find /etc/ /usr/bin/ /usr/sbin/ /bin/ /usr/local/bin/ -type f -mtime 0</td>\n<td>更改的信息</td>\n</tr>\n<tr>\n<td>find /tmp -iname “*” -atime 1 -type f</td>\n<td>访问的信息</td>\n</tr>\n<tr>\n<td>/var/run/utmp 有关当前登录用户的信息记录<br/>~/.ssh<br/>/etc/passwd 用户列表</td>\n<td>文件日期、新增文件、可疑 / 异常文件、最近使用文件、浏览器下载文件</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"日志\"><a class=\"markdownIt-Anchor\" href=\"#日志\">#</a> 日志</h4>\n<p>这里附上一张图片</p>\n<p><img data-src=\"https://gitee.com/chungod/picture/raw/master/image/image-20210505103536118.png\" alt=\"image-20210505103536118\"></p>\n<p>补充</p>\n<figure class=\"highlight c#\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">/<span class=\"keyword\">var</span>/log/wtmp 登录进入，退出，数据交换、关机和重启纪录，即last</span><br><span class=\"line\">/<span class=\"keyword\">var</span>/log/lastlog 文件记录用户最后登录的信息，即lastlog</span><br><span class=\"line\">/<span class=\"keyword\">var</span>/log/secure 记录登入系统存取数据的文件，如 pop3/ssh/telnet/ftp</span><br><span class=\"line\">/<span class=\"keyword\">var</span>/log/cron 与定时任务相关的日志信息，记录crontab命令是否被正确的执行</span><br><span class=\"line\">/<span class=\"keyword\">var</span>/log/message 系统启动后的信息和错误日志,包括整体系统信息</span><br><span class=\"line\">/<span class=\"keyword\">var</span>/log/apache2/access.log apache有关权限日志</span><br><span class=\"line\">/<span class=\"keyword\">var</span>/log/auth.log 包含系统授权信息，包括用户登录和使用的权限机制等</span><br><span class=\"line\">/<span class=\"keyword\">var</span>/log/userlog 记录所有等级用户信息的日志</span><br><span class=\"line\">/<span class=\"keyword\">var</span>/log/xferlog(vsftpd.log)记录Linux FTP日志</span><br><span class=\"line\">/<span class=\"keyword\">var</span>/log/secure 记录大多数应用输入的账号与密码，登录成功与否</span><br><span class=\"line\">/<span class=\"keyword\">var</span>/log/faillog 记录登录系统不成功的账号信息</span><br><span class=\"line\">扩展（历史记录）</span><br><span class=\"line\">history (cat /root/.bash_history)</span><br><span class=\"line\">mysql-history (cat /root/.mysql_history)</span><br></pre></td></tr></table></figure>\n<p>利用正则表达式筛选条件</p>\n<table>\n<thead>\n<tr>\n<th>正则表达式筛选条件</th>\n<th>效果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>grep ‘Failed’ /var/log/secure |awk ‘{print $11}’ |sort |uniq -c |sort -nr</td>\n<td>查看爆破失败的 IP</td>\n</tr>\n<tr>\n<td>grep ‘Accepted’ /var/log/secure |awk ‘{print $11}’ |sort |uniq -c |sort -nr</td>\n<td>查看登录成功的 IP</td>\n</tr>\n<tr>\n<td>grep “Failed password for root” /var/log/auth.log |awk ‘{print $11}’ |sort |uniq -c |sort -nr |more</td>\n<td>定位有多少 IP 在爆破主机的 root 帐号</td>\n</tr>\n<tr>\n<td>grep &quot;Accepted &quot; /var/log/auth.log |awk ‘{print $11}’ |sort |uniq -c |sort -nr |more</td>\n<td>登录成功的 IP</td>\n</tr>\n<tr>\n<td>tail -400f demo.log</td>\n<td>监控最后 400 行日志文件的变化 等价与 tail -n 400 -f （-f 参数是实时）</td>\n</tr>\n<tr>\n<td>uniq -c demo.log</td>\n<td>标记该行重复的数量，不重复值为 1</td>\n</tr>\n<tr>\n<td>grep -c ‘ERROR’ demo.log<br/>cat /var/log/secure |grep 'Accepted password‘</td>\n<td>输出文件 demo.log 中查找所有包行 ERROR 的行的数量</td>\n</tr>\n<tr>\n<td>grep &quot;Accepted &quot; /var/log/secure* |awk ‘{print $1,$2,$3,$9,$11}’</td>\n<td>查看登录成功的日期、用户名及 IP</td>\n</tr>\n<tr>\n<td>grep “refused” /var/log/secure* |awk {‘print $9’} |sort |uniq -c |sort -nr |more （开启 iptables 的情况）<br/>grep “Failed password” /var/log/secure* |grep -E -o “((<span 1,3=\"\">0-9</span>).(<span 1,3=\"\">0-9</span>).(<span 1,3=\"\">0-9</span>).(<span 1,3=\"\">0-9</span>))” |uniq -c (没开启防火墙的情况)</td>\n<td>查看试图爆破主机的 IP</td>\n</tr>\n<tr>\n<td>grep “Failed password for root” /var/log/secure |awk ‘{print $11}’ |sort</td>\n<td>查看爆破主机的 ROOT 账号的 IP</td>\n</tr>\n<tr>\n<td>grep “Failed password” /var/log/secure |awk {‘print $9’} |sort |uniq -c |sort -nr</td>\n<td>查看爆破用户名字典</td>\n</tr>\n<tr>\n<td print=\"\" $1,$2,$3,$9,$11=\"\">grep -o “Failed password” /var/log/secure|uniq -c<br/>grep &quot;Accepted &quot; /var/log/secure |awk ’</td>\n<td>查看爆破用户名字典</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"用户\"><a class=\"markdownIt-Anchor\" href=\"#用户\">#</a> 用户</h4>\n<table>\n<thead>\n<tr>\n<th>Linux 命令</th>\n<th>效果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>last</td>\n<td>显示用户最近登录信息</td>\n</tr>\n<tr>\n<td>cat /etc/shadow</td>\n<td>查看密码登陆相关信息</td>\n</tr>\n<tr>\n<td>uptime</td>\n<td>查看用户登陆时间</td>\n</tr>\n<tr>\n<td>/etc/sudoers</td>\n<td>sudo 用户列表</td>\n</tr>\n<tr>\n<td>awk -F: ‘($3==0){print$1}’ /etc/passwd</td>\n<td>查看 UID 为 0 的帐号</td>\n</tr>\n<tr>\n<td>awk -F: ‘($2==&quot;&quot;){print$1}’ /etc/shadow</td>\n<td>查看密码为空的账号</td>\n</tr>\n<tr>\n<td>cat /etc/passwd |grep -E “/bin/bash$”</td>\n<td>查看能够登录的帐号</td>\n</tr>\n<tr>\n<td>lastlog</td>\n<td>系统中所有用户最近一次登录信息</td>\n</tr>\n<tr>\n<td>lastb</td>\n<td>用户错误的登录列表</td>\n</tr>\n<tr>\n<td>more /etc/sudoers |grep -v “<sup>#|</sup>$” |grep “ALL=(ALL)”</td>\n<td>查看 sudo 权限的用户</td>\n</tr>\n<tr>\n<td>who</td>\n<td>查询 utmp 文件并报告当前登录的每个用户</td>\n</tr>\n<tr>\n<td>w</td>\n<td>查询 utmp 文件并显示当前系统中每个用户和它所运行的进程信息</td>\n</tr>\n<tr>\n<td>users</td>\n<td>打印当前登录的用户，每个用户名对应一个登录会话。如果一个用户不止一个登录会话，其用户名显示相同次数</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"进程\"><a class=\"markdownIt-Anchor\" href=\"#进程\">#</a> 进程</h4>\n<table>\n<thead>\n<tr>\n<th>进程命令</th>\n<th>效果</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>lsof</td>\n<td>列出当前系统打开文件的工具</td>\n</tr>\n<tr>\n<td>ps aux |grep pid |grep –v grep</td>\n<td>查看对应的进程信息</td>\n</tr>\n<tr>\n<td>lsof -i:1677</td>\n<td>查看指定端口对应的程序</td>\n</tr>\n<tr>\n<td>lsof -p 1234</td>\n<td>检查 pid 号为 1234 进程调用情况</td>\n</tr>\n<tr>\n<td>strace -f -p 1234</td>\n<td>跟踪分析 pid 号为 1234 的进程</td>\n</tr>\n<tr>\n<td>lsof -g gid</td>\n<td>找恶意文件关联的 lib 文件</td>\n</tr>\n<tr>\n<td>ps -ef</td>\n<td>查看全格式的全部进程</td>\n</tr>\n<tr>\n<td>pstree -a</td>\n<td>以树状图的方式展现进程之间的派生关系</td>\n</tr>\n<tr>\n<td>ps -ef |awk ‘{print}’ |sort -n |uniq &gt;1<br/>ls /proc |sort -n |uniq &gt;2</td>\n<td>隐藏进程查看</td>\n</tr>\n<tr>\n<td>diff 1 2</td>\n<td>比较文本文件的异同处</td>\n</tr>\n<tr>\n<td>netstat -anptl</td>\n<td>显示网络状态，端口信息</td>\n</tr>\n<tr>\n<td>top</td>\n<td>实时显示系统中各个进程的资源占用状况</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"自启动\"><a class=\"markdownIt-Anchor\" href=\"#自启动\">#</a> 自启动</h4>\n<table>\n<thead>\n<tr>\n<th>启动配置文件</th>\n<th>特征</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>~/.bashrc</td>\n<td>用户 HOME 家目录启动文件</td>\n</tr>\n<tr>\n<td>/etc/rc.local</td>\n<td>开机启动程序</td>\n</tr>\n<tr>\n<td>/etc/init.d/ 服务</td>\n<td>服务启动关闭</td>\n</tr>\n<tr>\n<td>/etc/cron*</td>\n<td>定时任务</td>\n</tr>\n<tr>\n<td>chkconfig --list |grep “3:on|5:on”</td>\n<td>查看开机自启动服务</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"计划任务\"><a class=\"markdownIt-Anchor\" href=\"#计划任务\">#</a> 计划任务</h4>\n<table>\n<thead>\n<tr>\n<th>查看计划任务命令</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>crontab -l &amp; cat /etc/crontab &amp; ls /etc/cron.* 查看计划任务</td>\n</tr>\n<tr>\n<td>crontab -e  进行修改计划任务</td>\n</tr>\n<tr>\n<td>crontab -u root -l  显示 root 用户计划任务</td>\n</tr>\n<tr>\n<td>配置文件</td>\n</tr>\n<tr>\n<td>/var/spool/cron/*    root 用户执行的就会在 /var/spool/cron/ 下面创建 root 文件</td>\n</tr>\n<tr>\n<td>/etc/cron.d    cron 任务可以根据调度来执行</td>\n</tr>\n<tr>\n<td>/etc/cron.daily/     每日计划 *<br/>/etc/cron.hourly/   小时计划 *<br/>/etc/cron.monthly/  月计划 *<br/>/etc/cron.weekly/   周计划</td>\n</tr>\n<tr>\n<td>/etc/anacrontab   Anacrontab 的配置入口</td>\n</tr>\n<tr>\n<td>/var/log/cron*   日志计划程序</td>\n</tr>\n</tbody>\n</table>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">misc 杂</span><br><span class=\"line\">stat 命令查看文件或文件系统的状态时间等属性</span><br><span class=\"line\">echo $PATH 查看环境变量</span><br><span class=\"line\">&#x2F;rpm -Va &gt; rpm.log 校验所有的RPM软件包，查找丢失的文件</span><br><span class=\"line\">kill -9 强制杀死进程</span><br><span class=\"line\">chattr –i 取消锁定文件</span><br><span class=\"line\">setfacl &#x2F; getfacl  ACL权限设置</span><br><span class=\"line\">chmod 000 去执行权限</span><br><span class=\"line\">strings &#x2F;usr&#x2F;bin&#x2F;.sshd | egrep &#39;[1-9]&#123;1,3&#125;.[1-9]&#123;1,3&#125;.&#39; ssh后门快速判断</span><br></pre></td></tr></table></figure>\n<h2 id=\"windows取证\"><a class=\"markdownIt-Anchor\" href=\"#windows取证\">#</a> Windows 取证</h2>\n<p>思维导图</p>\n<p><img data-src=\"https://gitee.com/chungod/picture/raw/master/image/image-20210505135434533.png\" alt=\"image-20210505135434533\"></p>\n<h4 id=\"文件-2\"><a class=\"markdownIt-Anchor\" href=\"#文件-2\">#</a> 文件</h4>\n<p>分析文件路径</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br><span class=\"line\">11</span><br><span class=\"line\">12</span><br><span class=\"line\">13</span><br><span class=\"line\">14</span><br><span class=\"line\">15</span><br><span class=\"line\">16</span><br><span class=\"line\">17</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">文件路径</span><br><span class=\"line\">C:\\Documents and Settings\\Administrator\\Recent</span><br><span class=\"line\">C:\\Documents and Settings\\Default User\\Recent</span><br><span class=\"line\">%UserProfile%\\Recent  文件日期、新增文件、可疑&#x2F;异常文件、最近使用文件、浏览器下载文件</span><br><span class=\"line\">下载目录</span><br><span class=\"line\">回收站文件</span><br><span class=\"line\">程序临时文件</span><br><span class=\"line\">历史文件记录</span><br><span class=\"line\">应用程序打开历史</span><br><span class=\"line\">搜索历史</span><br><span class=\"line\">快捷方式（LNK）</span><br><span class=\"line\">c:\\windows\\temp\\</span><br><span class=\"line\">Window 2003 C:\\Documents and Settings</span><br><span class=\"line\">Window 2008R2 C:\\Users\\</span><br><span class=\"line\">时间排序文件</span><br><span class=\"line\">findstr &#x2F;s &#x2F;m &#x2F;I “UploadFiles” *.log  查看指定时间范围包括上传文件夹的访问请求</span><br><span class=\"line\">findstr &#x2F;s &#x2F;m &#x2F;I “x.js” *.asp 关键信息是x.js</span><br></pre></td></tr></table></figure>\n<h4 id=\"日志-2\"><a class=\"markdownIt-Anchor\" href=\"#日志-2\">#</a> 日志</h4>\n<table>\n<thead>\n<tr>\n<th>日志类型</th>\n<th>命令</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>系统日志，程序日志，安全日志</td>\n<td>eventvwr.msc</td>\n</tr>\n<tr>\n<td>服务器日志</td>\n<td>FTP 连接日志和 HTTPD 事务日志：% systemroot% \\system32\\LogFiles\\ <br/>IIS 日志默认存放在 System32\\LogFiles 目录下，使用 W3C 扩展格式</td>\n</tr>\n<tr>\n<td>操作系统日志</td>\n<td>登录成功的所有事件：<br/>LogParser.exe -i:EVT –o:DATAGRID “SELECT * FROM c:\\Security.evtx where EventID=4624″</td>\n</tr>\n<tr>\n<td>指定登录时间范围的事件：</td>\n<td>LogParser.exe -i:EVT –o:DATAGRID “SELECT * FROM c:\\Security.evtx where TimeGenerated&gt;’2018-<br/>06-19 23:32:11′ and TimeGenerated&lt;’2018-06-20 23:34:00′ and EventID=4624″</td>\n</tr>\n<tr>\n<td>提取登录成功的用户名和 IP</td>\n<td>LogParser.exe -i:EVT –o:DATAGRID “SELECT EXTRACT_TOKEN(Message,13,’ ‘)as<br/>EventType,TimeGenerated as LoginTime,EXTRACT_TOKEN(Strings,5,’|’) as<br/>Username,EXTRACT_TOKEN(Message,38,’ ‘) as Loginip FROM c:\\Security.evtx where EventID=4624″</td>\n</tr>\n<tr>\n<td>登录失败的所有事件</td>\n<td>LogParser.exe -i:EVT –o:DATAGRID “SELECT * FROM c:\\Security.evtx where EventID=4625″</td>\n</tr>\n<tr>\n<td>提取登录失败用户名进行聚合统计</td>\n<td>LogParser.exe -i:EVT “SELECT EXTRACT_TOKEN(Message,13,’ ‘) as <br/> as user,count(EXTRACT_TOKEN(Message,19,’ ‘)) as Times,EXTRACT_TOKEN(Message,39,’ ‘)   as Loginip FROM c:\\Security.evtx where <br/> EventID=4625GROUP BY Message”<br/></td>\n</tr>\n<tr>\n<td>系统历史开关机记录</td>\n<td>LogParser.exe -i:EVT –o:DATAGRID “SELECT TimeGenerated,EventID,Message FROM c:\\System.evtx where EventID=6005 or EventID=6006″<br/></td>\n</tr>\n</tbody>\n</table>\n<p>常用事件 ID 含义</p>\n<table>\n<thead>\n<tr>\n<th>Event ID(2000/XP/2003)</th>\n<th>Event ID(Vista/7/8/2008/2012)</th>\n<th>描述</th>\n<th>日志名称</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>528</td>\n<td>4624</td>\n<td>成功登录</td>\n<td>Security</td>\n</tr>\n<tr>\n<td>529</td>\n<td>4625</td>\n<td>失败登录</td>\n<td>Security</td>\n</tr>\n<tr>\n<td>680</td>\n<td>4776</td>\n<td>成功 / 失败的账户认证</td>\n<td>Security</td>\n</tr>\n<tr>\n<td>624</td>\n<td>4720</td>\n<td>创建用户</td>\n<td>Security</td>\n</tr>\n<tr>\n<td>636</td>\n<td>4732</td>\n<td>添加用户到启用安全性的本地组中</td>\n<td>Security</td>\n</tr>\n<tr>\n<td>632</td>\n<td>4728</td>\n<td>添加用户到启用安全性的全局组中</td>\n<td>Security</td>\n</tr>\n<tr>\n<td>2934</td>\n<td>7030</td>\n<td>服务创建错误</td>\n<td>System</td>\n</tr>\n<tr>\n<td>2944</td>\n<td>7040</td>\n<td>IPSEC 服务服务的启动类型已从禁用更改为自动启动</td>\n<td>System</td>\n</tr>\n<tr>\n<td>2949</td>\n<td>7045</td>\n<td>服务创建</td>\n<td>System</td>\n</tr>\n</tbody>\n</table>\n<p>登录类型 ID</p>\n<p>成功 / 失败登录事件提供的有用信息之一是用户 / 进程尝试登录（登录类型），但 Windows 将此信息显示为数字，下面是数字和对应的说明：</p>\n<table>\n<thead>\n<tr>\n<th><strong>录类型</strong></th>\n<th><strong>登录类型</strong></th>\n<th><strong>描述</strong></th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>2</td>\n<td>Interactive</td>\n<td>用户登录到本机</td>\n</tr>\n<tr>\n<td>3</td>\n<td>Network</td>\n<td>用户或计算手机从网络登录到本机，如果网络共享，或使用 net use 访问网络共享，net view 查看网络共享</td>\n</tr>\n<tr>\n<td>4</td>\n<td>Batch</td>\n<td>批处理登录类型，无需用户干预</td>\n</tr>\n<tr>\n<td>5</td>\n<td>Service</td>\n<td>服务控制管理器登录</td>\n</tr>\n<tr>\n<td>7</td>\n<td>Unlock</td>\n<td>用户解锁主机</td>\n</tr>\n<tr>\n<td>8</td>\n<td>NetworkCleartext</td>\n<td>用户从网络登录到此计算机，用户密码用非哈希的形式传递</td>\n</tr>\n<tr>\n<td>9</td>\n<td>NewCredentials</td>\n<td>进程或线程克隆了其当前令牌，但为出站连接指定了新凭据</td>\n</tr>\n<tr>\n<td>10</td>\n<td>Remotelnteractive</td>\n<td>使用终端服务或远程桌面连接登录</td>\n</tr>\n<tr>\n<td>11</td>\n<td>Cachedlnteractive</td>\n<td>用户使用本地存储在计算机上的凭据登录到计算机（域控制器可能无法验证凭据），如主机不能连接域控，以前使用域账户登录过这台主机，再登录就会产生这样日志</td>\n</tr>\n<tr>\n<td>12</td>\n<td>CachedRemotelnteractive</td>\n<td>与 Remotelnteractive 相同，内部用于审计目的</td>\n</tr>\n<tr>\n<td>13</td>\n<td>CachedUnlock</td>\n<td>登录尝试解锁</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"账号\"><a class=\"markdownIt-Anchor\" href=\"#账号\">#</a> 账号</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br><span class=\"line\">8</span><br><span class=\"line\">9</span><br><span class=\"line\">10</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">新增用户</span><br><span class=\"line\">隐藏&#x2F;克隆帐号</span><br><span class=\"line\">管理员对应键值</span><br><span class=\"line\">lusrmgr.msc 查看账户变化</span><br><span class=\"line\">net user 列出当前登录账户</span><br><span class=\"line\">wmic UserAccount get 列出当前系统所有账户</span><br><span class=\"line\">net localgroup administrators 列出管理员组用户</span><br><span class=\"line\">注册表-管理员键值：HKEY_LOCAL_MACHINE&#x2F;SAM&#x2F;SAM&#x2F;Domains&#x2F;Account&#x2F;Users</span><br><span class=\"line\">D盾查杀</span><br><span class=\"line\">日志-登录时间&#x2F;用户名</span><br></pre></td></tr></table></figure>\n<h4 id=\"进程-2\"><a class=\"markdownIt-Anchor\" href=\"#进程-2\">#</a> 进程</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">tasklist &#x2F;svc | findstr pid  查看服务进行</span><br><span class=\"line\">netstat -ano</span><br><span class=\"line\">wmic process | find &quot;Proccess Id&quot; &gt; proc.csv</span><br><span class=\"line\">powershell: Get-WmiObject -Class Win32_Process</span><br><span class=\"line\">msinfo32 查看自己电脑配置详情</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight powershell\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">扩展powershell命令</span><br><span class=\"line\">wmic <span class=\"keyword\">process</span> get caption,commandline /value</span><br><span class=\"line\">wmic <span class=\"keyword\">process</span> <span class=\"built_in\">where</span> caption=”svchost.exe” get caption,commandline /value</span><br><span class=\"line\">wmic service get name,pathname,processid,startname,status,state /value</span><br><span class=\"line\">wmic <span class=\"keyword\">process</span> get CreationDate,name,processid,commandline,ExecutablePath /value</span><br><span class=\"line\">wmic <span class=\"keyword\">process</span> get name,processid,executablepath| findstr <span class=\"string\">&quot;7766&quot;</span></span><br></pre></td></tr></table></figure>\n<h4 id=\"端口\"><a class=\"markdownIt-Anchor\" href=\"#端口\">#</a> 端口</h4>\n<p><code>netstat -ano</code></p>\n<table>\n<thead>\n<tr>\n<th>端口状态</th>\n<th>说明</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>CLOSED</td>\n<td>无连接活动或正在进行</td>\n</tr>\n<tr>\n<td>LISTEN</td>\n<td>监听中等待连接</td>\n</tr>\n<tr>\n<td>SYN_RECV</td>\n<td>服务端接收了 SYN</td>\n</tr>\n<tr>\n<td>SYN_SENT</td>\n<td>请求连接等待确认</td>\n</tr>\n<tr>\n<td>ESTABLISHED</td>\n<td>连接建立数据传输</td>\n</tr>\n<tr>\n<td>FIN_WAIT1</td>\n<td>请求中止连接，等待对方 FIN</td>\n</tr>\n<tr>\n<td>FIN_WAIT2</td>\n<td>同意中止，请稍候</td>\n</tr>\n<tr>\n<td>ITMED_WAIT</td>\n<td>等待所有分组死掉</td>\n</tr>\n<tr>\n<td>CLOSING</td>\n<td>两边同时尝试关闭</td>\n</tr>\n<tr>\n<td>TIME_WAIT</td>\n<td>另一边已初始化一个释放</td>\n</tr>\n<tr>\n<td>LAST_ACK</td>\n<td>等待原来的发向远程 TCP 的连接中断请求的确认</td>\n</tr>\n<tr>\n<td>CLOSE-WAIT</td>\n<td>等待关闭连接</td>\n</tr>\n</tbody>\n</table>\n<h4 id=\"自启动-2\"><a class=\"markdownIt-Anchor\" href=\"#自启动-2\">#</a> 自启动</h4>\n<p>注册表位置</p>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Run</span><br><span class=\"line\">HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\Runonce</span><br><span class=\"line\">HKEY_LOCAL_MACHINE\\Software\\Microsoft\\Windows\\CurrentVersion\\policies\\Explorer\\Run</span><br><span class=\"line\">HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\Run</span><br><span class=\"line\">HKEY_CURRENT_USER\\Software\\Microsoft\\Windows\\CurrentVersion\\RunOnce</span><br><span class=\"line\">HKLM\\Software\\Microsoft\\Windows\\CurrentVersion\\RunonceEx</span><br></pre></td></tr></table></figure>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">(ProfilePath)\\Start Menu\\Programs\\Startup 启动项</span><br><span class=\"line\">shell:startup  查看开机自启</span><br><span class=\"line\">msconfig 启动选项卡</span><br><span class=\"line\">gpedit.msc 组策略编辑器</span><br><span class=\"line\">开始&gt;所有程序&gt;启动</span><br><span class=\"line\">wmic startup list full</span><br></pre></td></tr></table></figure>\n<h4 id=\"计划任务-2\"><a class=\"markdownIt-Anchor\" href=\"#计划任务-2\">#</a> 计划任务</h4>\n<figure class=\"highlight plain\"><table><tr><td class=\"gutter\"><pre><span class=\"line\">1</span><br><span class=\"line\">2</span><br><span class=\"line\">3</span><br><span class=\"line\">4</span><br><span class=\"line\">5</span><br><span class=\"line\">6</span><br><span class=\"line\">7</span><br></pre></td><td class=\"code\"><pre><span class=\"line\">C:\\Windows\\System32\\Tasks\\</span><br><span class=\"line\">C:\\Windows\\SysWOW64\\Tasks\\</span><br><span class=\"line\">C:\\Windows\\tasks\\</span><br><span class=\"line\">schtasks</span><br><span class=\"line\">taskschd.msc</span><br><span class=\"line\">at</span><br><span class=\"line\">开始-设置-控制面板-任务计划</span><br></pre></td></tr></table></figure>\n<h4 id=\"注册表\"><a class=\"markdownIt-Anchor\" href=\"#注册表\">#</a> 注册表</h4>\n<table>\n<thead>\n<tr>\n<th>注册表位置</th>\n<th>对应信息</th>\n</tr>\n</thead>\n<tbody>\n<tr>\n<td>HKEY_LOCAL_MACHINE\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\ProfileList</td>\n<td>临时配置文件</td>\n</tr>\n<tr>\n<td>HKLM\\SAM\\Domains\\Account\\</td>\n<td>用户信息</td>\n</tr>\n<tr>\n<td>hklm:\\Software\\Microsoft\\Windows\\CurrentVersion\\policies\\system</td>\n<td>UAC 注册表位置</td>\n</tr>\n<tr>\n<td>hklm:\\Software\\Microsoft\\Active Setup\\Installed Components</td>\n<td>安装的组件信息</td>\n</tr>\n<tr>\n<td>hklm:\\Software\\Microsoft\\Windows\\CurrentVersion\\App Paths</td>\n<td>软件环境变量</td>\n</tr>\n<tr>\n<td>hklm:\\software\\microsoft\\windows nt\\CurrentVersion\\winlogon</td>\n<td>系统启动</td>\n</tr>\n<tr>\n<td>hklm:\\software\\microsoft\\security center\\svc</td>\n<td>安全中心报警</td>\n</tr>\n<tr>\n<td>hkcu:\\Software\\Microsoft\\Windows\\CurrentVersion\\Explorer\\TypedPaths</td>\n<td>让源管理器中的地址栏不记录文件的打开记录</td>\n</tr>\n<tr>\n<td>hkcu:\\Software\\Microsoft\\Windows\\CurrentVersion\\explorer\\RunMru</td>\n<td>禁止自动保存运行记录</td>\n</tr>\n<tr>\n<td>hklm:\\Software\\Microsoft\\Windows\\CurrentVersion\\explorer\\Startmenu</td>\n<td>软件自动启动项</td>\n</tr>\n<tr>\n<td>hklm:\\System\\CurrentControlSet\\Control\\Session Manager</td>\n<td>装载 Win32 子系统内核模式部分</td>\n</tr>\n<tr>\n<td>hkcu:\\Software\\Microsoft\\Internet Explorer\\Extensions</td>\n<td>记录最后下载软件的存储位置</td>\n</tr>\n<tr>\n<td>hklm:\\Software\\Microsoft\\Windows\\CurrentVersion\\ShellExtensions\\Approved</td>\n<td>系统或者用户已注册的外壳扩展功能模块</td>\n</tr>\n<tr>\n<td>hklm:\\System\\CurrentControlSet\\Control\\Session Manager\\AppCertDlls</td>\n<td>后门及持久化访问</td>\n</tr>\n</tbody>\n</table>\n<p>本文内容借鉴：应急响应实战 checklist pdf</p>\n<p>博客：<span class=\"exturl\" data-url=\"aHR0cHM6Ly94ei5hbGl5dW4uY29tL3QvMjUyNA==\">https://xz.aliyun.com/t/2524</span></p>\n",
            "tags": [
                "溯源取证总结"
            ]
        }
    ]
}